<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.47">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tommaso Ghilardi, Francesco Poli">
<meta name="dcterms.date" content="2024-05-20">
<meta name="keywords" content="PsychoPy, Python, eye-tracking, tobii, tobii_research, experimental psychology, tutorial, experiment, DevStart, developmental science">
<meta name="description" content="Learn how to record eyetracking data in your psychopy experiment using Tobii SDK, tobii_research">

<title>Create an eye-tracking experiment – DevStart</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../CONTENT/EyeTracking/EyetrackingCalibration.html" rel="next">
<link href="../../CONTENT/EyeTracking/Intro_eyetracking.html" rel="prev">
<link href="../../resources/ICON.png" rel="icon" type="image/png">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-G5XSH1GLW7"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-G5XSH1GLW7', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"dark",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  


<meta property="og:title" content="DevStart">
<meta property="og:description" content="Getting started with developmental science">
<meta property="og:image" content="https://tommasoghilardi.github.io/DevStart/CONTENT/EyeTracking/images/ICON.png">
<meta property="og:site_name" content="DevStart">
<meta name="twitter:title" content="DevStart">
<meta name="twitter:description" content="DevStart, getting started with developmental science">
<meta name="twitter:image" content="https://tommasoghilardi.github.io/DevStart/CONTENT/EyeTracking/images/ICON.png">
<meta name="twitter:site" content="@DevSciStart">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../CONTENT/EyeTracking/Intro_eyetracking.html">Eye-tracking</a></li><li class="breadcrumb-item"><a href="../../CONTENT/EyeTracking/CreateAnEyetrackingExperiment.html">Create an eye-tracking experiment</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header sidebar-header-stacked">
      <a href="../../index.html" class="sidebar-logo-link">
      <img src="../../images/LOGO.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../../"></a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://x.com/DevSciStart" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/TommasoGhilardi/DevStart">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/TommasoGhilardi/DevStart/issues">
            Report a Bug
            </a>
          </li>
      </ul>
    </div>
    <a href="../../CONTENT/ContentList.html" title="Content listing" class="quarto-navigation-tool px-1" aria-label="Content listing"><i class="bi bi-menu-up"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome to DevStart</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting started:</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/GettingStarted/GettingStartedWithPython.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Starting with Python</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/GettingStarted/GettingStartedWithPsychopy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Starting with PsychoPy</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../CONTENT/GettingStarted/CreateYourFirstParadigm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Creating an experiment:</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/GettingStarted/CreateYourFirstParadigm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create your first paradigm</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../CONTENT/EyeTracking/Intro_eyetracking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Eye-tracking</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/EyeTracking/Intro_eyetracking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to eye-tracking</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/EyeTracking/CreateAnEyetrackingExperiment.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Create an eye-tracking experiment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/EyeTracking/EyetrackingCalibration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Calibrating eye-tracking</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/EyeTracking/I2MC_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using I2MC for robust fixation extraction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/EyeTracking/FromFixationsToData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">From fixations to measures</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/EyeTracking/PupilPreprocessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pupil data pre-processing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/EyeTracking/PupilDataAnalysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pupil Data Analysis</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Stats</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/Stats/LinearModels.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/Stats/LinearMixedModels.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear mixed effect models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/Stats/ModelEstimates.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ModelEstimates</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../CONTENT/Stats/GeneralisedModels.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generalised mixed-effect models</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="https://tommasoghilardi.github.io/DevStart/Workshops/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Workshops</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://tommasoghilardi.github.io/DevStart/Workshops/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Eye-Tracking Workshop for Developmental Scientists</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://tommasoghilardi.github.io/DevStart/Workshops/PreviousWokshops/BTG2024.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">BTG 2024</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="4">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#tobii_sdk" id="toc-tobii_sdk" class="nav-link active" data-scroll-target="#tobii_sdk">Tobii_sdk</a>
  <ul class="collapse">
  <li><a href="#install" id="toc-install" class="nav-link" data-scroll-target="#install">Install</a></li>
  <li><a href="#connect-to-the-eye-tracker" id="toc-connect-to-the-eye-tracker" class="nav-link" data-scroll-target="#connect-to-the-eye-tracker">Connect to the eye-tracker</a></li>
  <li><a href="#collect-data" id="toc-collect-data" class="nav-link" data-scroll-target="#collect-data">Collect data</a>
  <ul class="collapse">
  <li><a href="#global-to-save" id="toc-global-to-save" class="nav-link" data-scroll-target="#global-to-save">Global to save</a></li>
  </ul></li>
  <li><a href="#triggersevents" id="toc-triggersevents" class="nav-link" data-scroll-target="#triggersevents">Triggers/Events</a></li>
  <li><a href="#save-the-data" id="toc-save-the-data" class="nav-link" data-scroll-target="#save-the-data">Save the data</a>
  <ul class="collapse">
  <li><a href="#the-buffer-swap-technique" id="toc-the-buffer-swap-technique" class="nav-link" data-scroll-target="#the-buffer-swap-technique">The Buffer Swap Technique</a></li>
  <li><a href="#align-events-and-data" id="toc-align-events-and-data" class="nav-link" data-scroll-target="#align-events-and-data">Align events and data</a></li>
  </ul></li>
  <li><a href="#clean-and-prepare-your-data" id="toc-clean-and-prepare-your-data" class="nav-link" data-scroll-target="#clean-and-prepare-your-data">Clean and Prepare Your Data</a></li>
  <li><a href="#split-gaze-coordinates-into-separate-columns" id="toc-split-gaze-coordinates-into-separate-columns" class="nav-link" data-scroll-target="#split-gaze-coordinates-into-separate-columns">Split Gaze Coordinates into Separate Columns</a>
  <ul class="collapse">
  <li><a href="#adjust-the-data" id="toc-adjust-the-data" class="nav-link" data-scroll-target="#adjust-the-data">Adjust the Data</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#create-the-actual-experiment" id="toc-create-the-actual-experiment" class="nav-link" data-scroll-target="#create-the-actual-experiment">Create the Actual Experiment</a>
  <ul class="collapse">
  <li><a href="#short-recap-of-the-paradigm" id="toc-short-recap-of-the-paradigm" class="nav-link" data-scroll-target="#short-recap-of-the-paradigm">Short Recap of the Paradigm</a></li>
  <li><a href="#putting-it-all-together" id="toc-putting-it-all-together" class="nav-link" data-scroll-target="#putting-it-all-together">Putting It All Together</a>
  <ul class="collapse">
  <li><a href="#import-libraries-and-define-functions" id="toc-import-libraries-and-define-functions" class="nav-link" data-scroll-target="#import-libraries-and-define-functions">Import Libraries and Define Functions</a></li>
  <li><a href="#load-the-stimuli" id="toc-load-the-stimuli" class="nav-link" data-scroll-target="#load-the-stimuli">Load the Stimuli</a></li>
  <li><a href="#start-recording" id="toc-start-recording" class="nav-link" data-scroll-target="#start-recording">Start recording</a></li>
  <li><a href="#present-our-stimuli" id="toc-present-our-stimuli" class="nav-link" data-scroll-target="#present-our-stimuli">Present Our Stimuli</a></li>
  <li><a href="#stop-recording" id="toc-stop-recording" class="nav-link" data-scroll-target="#stop-recording">Stop recording</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#end" id="toc-end" class="nav-link" data-scroll-target="#end">END!!</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../CONTENT/EyeTracking/Intro_eyetracking.html">Eye-tracking</a></li><li class="breadcrumb-item"><a href="../../CONTENT/EyeTracking/CreateAnEyetrackingExperiment.html">Create an eye-tracking experiment</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Create an eye-tracking experiment</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">Eye-tracking</div>
    <div class="quarto-category">Python</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 20, 2024</p>
    </div>
  </div>
  
    
  </div>
  

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>PsychoPy, Python, eye-tracking, tobii, tobii_research, experimental psychology, tutorial, experiment, DevStart, developmental science</p>
  </div>
</div>

</header>


<p>This page will show you how to collect eye-tracking data in a simple Psychopy paradigm. We will use the same paradigm that we built together in the <a href="../../CONTENT/GettingStarted/GettingStartedWithPsychopy.html">Getting started with Psychopy</a> tutorial. If you have not done that tutorial yet, please go through it first.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Tobii eye-tracker</strong></p>
<p>Note that this tutorial is specific for using <strong>Tobii eye-trackers</strong>. The general steps and idea are obviously applicable to other eye-trackers, but the specific code and packages may vary.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Our Approach</strong></p>
<p>The method we’ll show you here is designed to be <strong>simple and functional</strong> rather than the most efficient or sophisticated approach possible. There are more advanced techniques for handling eye tracking data collection, buffer management, and event synchronization, but we’ve prioritized code that’s easy to understand and modify.</p>
<p>Our goal is to get you up and running with a working eye tracking experiment that you can build upon. Once you’re comfortable with these basics, you can always optimize and refine your approach for more demanding applications.</p>
</div>
</div>
<section id="tobii_sdk" class="level1">
<h1>Tobii_sdk</h1>
<p>To start, we will look into how to connect and talk to our Tobii eyetracker with the <strong>SDK</strong> that Tobii provides. An <strong>SDK</strong> is a collection of tools and programs for developing applications for a specific platform or device. We will use the <strong>Python Tobii SDK</strong> that lets us easily find and get data from our Tobii eye tracker.</p>
<section id="install" class="level2">
<h2 class="anchored" data-anchor-id="install">Install</h2>
<p>To install the Python Tobii SDK, we can simply run this command in our conda terminal:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install tobii_research</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="info-box info-box-large">
<div class="info-box-title">
<p>Compatibility older eye-trackers</p>
</div>
<p>If you’re using an older Tobii eye-tracker, check the compatibility page to see which version of tobii_research you need for your specific model. Check it <a href="https://developer.tobiipro.com/tobiiprosdk/eyetrackercompatibility.html">here</a>.</p>
</div>
<p>Great! We have installed the Tobii SDK.</p>
</section>
<section id="connect-to-the-eye-tracker" class="level2">
<h2 class="anchored" data-anchor-id="connect-to-the-eye-tracker">Connect to the eye-tracker</h2>
<p>So how does this library work, how do we connect to the eye-tracker and collect our data? Very good questions!</p>
<p>The <code>tobii_research</code> documentation is quite extensive and describes in detail a lot of functions and data classes that are very useful. However, we don’t need much to start our experiment.</p>
<p>First we need to identify all the eye trackers connected to our computer. Yes, plural, <code>tobii_research</code> will return a list of all the eye trackers connected to our computer. 99.99999999% of the time you will only have 1 eye tracker connected, so we can just select the first (and usually only) eye tracker found.</p>
<div id="301ba0d7" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import tobii_research library</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tobii_research <span class="im">as</span> tr</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Find all connected eye trackers</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>found_eyetrackers <span class="op">=</span> tr.find_all_eyetrackers()</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># We will just use the first one</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>Eyetracker <span class="op">=</span> found_eyetrackers[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Perfect!! We have identified our eye-trackers, and we have selected the first one (and only).</p>
<p>We are now ready to use our eye-tracker to collect some data… but how?</p>
</section>
<section id="collect-data" class="level2">
<h2 class="anchored" data-anchor-id="collect-data">Collect data</h2>
<p>Tobii_research has a cool way of telling us what data we are collecting at each time point. It uses a callback function. What is a callback function, you ask? It is a function that tobii runs each time it has a new data point. Let’s say we have an eye tracker that collects data at 300Hz (300 samples per second): the function will be called every time the tobii has one of those 300 samples.</p>
<p>This callback function will give us a <code>gaze_data</code> dictionary. This dictionary contains multiple information of that collected sample</p>
<p>Here is our callback function:</p>
<div id="26c54f41" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># callback function</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaze_data_callback(gaze_data):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(gaze_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will print the entire dictionary to your console. Here’s what you’ll see:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>{<span class="st">'device_time_stamp'</span>: <span class="dv">467525500</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a> <span class="st">'system_time_stamp'</span>: <span class="dv">6405415231</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_gaze_point_on_display_area'</span>: (<span class="fl">0.4633694291</span>, <span class="fl">0.4872185290</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_gaze_point_in_user_coordinate_system'</span>: (<span class="op">-</span><span class="fl">10.15791702</span>, <span class="fl">128.29026794</span>, <span class="fl">40.876254</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_gaze_point_validity'</span>: <span class="dv">1</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_pupil_diameter'</span>: <span class="fl">5.655228</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_pupil_validity'</span>: <span class="dv">1</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_gaze_origin_in_user_coordinate_system'</span>: (<span class="op">-</span><span class="fl">25.86829758</span>, <span class="fl">1.41938722</span>, <span class="fl">644.839478</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_gaze_origin_in_trackbox_coordinate_system'</span>: (<span class="fl">0.561557</span>, <span class="fl">0.481128</span>, <span class="fl">0.489121</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_gaze_origin_validity'</span>: <span class="dv">1</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_gaze_point_on_display_area'</span>: (<span class="fl">0.4944303632</span>, <span class="fl">0.4498708546</span>),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_gaze_point_in_user_coordinate_system'</span>: (<span class="fl">0.7905667424</span>, <span class="fl">135.2486572266</span>, <span class="fl">43.373546</span>),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_gaze_point_validity'</span>: <span class="dv">1</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_pupil_diameter'</span>: <span class="fl">5.307220</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_pupil_validity'</span>: <span class="dv">1</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_gaze_origin_in_user_coordinate_system'</span>: (<span class="fl">32.52792358398</span>, <span class="op">-</span><span class="fl">2.97285223007</span>, <span class="fl">640.345520</span>),</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_gaze_origin_in_trackbox_coordinate_system'</span>: (<span class="fl">0.431783</span>, <span class="fl">0.495703</span>, <span class="fl">0.483452</span>),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_gaze_origin_validity'</span>: <span class="dv">1</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Wow! Look at all that data from just one sample!</p>
<p>Now we need to tell the eye tracker to actually use our callback function. This part is super easy:</p>
<div id="9e5166cb" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start the callback function</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>Eyetracker.subscribe_to(tr.EYETRACKER_GAZE_DATA, gaze_data_callback)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What we’re doing here is subscribing to the <code>EYETRACKER_GAZE_DATA</code> stream and telling it to send all that data to our <code>gaze_data_callback</code> function. Once this runs, your console will start flooding with data!</p>
<section id="global-to-save" class="level3">
<h3 class="anchored" data-anchor-id="global-to-save">Global to save</h3>
<p>Great! You’ve set up a callback function that receives eye tracking data from your device. However, printing 300 data points per second to the console creates an unreadable stream of text that’s not useful for analysis. We need to store this data properly.</p>
<p>Let’s create a list to collect all the gaze data:</p>
<div id="af0679ad" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list we will append our data to</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>gaze_data_buffer <span class="op">=</span> []</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Perfect! We’ve got our list to which we can append the incoming data. We can simply have this list inside of our callback function so every time an new sample appears it will be added there. This is how our script could look now:</p>
<div id="5e5b0ee6" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># callback function</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaze_data_callback(gaze_data):</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    gaze_data_buffer.append(gaze_data)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list we will append our data to</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>gaze_data_buffer <span class="op">=</span> []</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Start the callback function</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>Eyetracker.subscribe_to(tr.EYETRACKER_GAZE_DATA, gaze_data_callback, as_dictionary<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice the <code>global</code> keyword in the callback function. This tells Python that we want to use the <code>gaze_data_buffer</code> variable that was created outside the function. Without this keyword, Python may create a new local variable instead of using our existing list.</p>
<p>Now instead of flooding the console, every new sample gets stored in our list for later analysis!</p>
</section>
</section>
<section id="triggersevents" class="level2">
<h2 class="anchored" data-anchor-id="triggersevents">Triggers/Events</h2>
<p>As we’ve seen, our callback function can access Tobii data and process each sample. But there’s one crucial piece missing: <strong>we need to know exactly when we presented our stimuli</strong>.</p>
<p>In most studies, we present various stimuli - pictures, sounds, or videos. For meaningful analysis, we must know the precise timing of when each stimulus appeared.</p>
<p>The Tobii SDK provides an elegant solution through the <code>tr.get_system_time_stamp()</code> function. This function returns the current time using the same system clock that the eye tracker uses for its data timestamps. Remember that each gaze sample includes a <code>system_time_stamp</code> field? This means we can perfectly synchronize our events with the gaze data.</p>
<p>We can create a simple event-logging system by storing timestamps alongside descriptive labels:</p>
<div id="48937dad" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>Events <span class="op">=</span> [] <span class="co"># create empty list</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the current time from the eye-tracker's clock</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>Events.append({<span class="st">'system_time_stamp'</span>:  tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Our First event!!'</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="save-the-data" class="level2">
<h2 class="anchored" data-anchor-id="save-the-data">Save the data</h2>
<p>Perfect! Now we have two lists containing all our information. They grow continuously (especially the <code>gaze_data_buffer</code>) and we need an efficient way to save them.</p>
<p>There are two common approaches:</p>
<ol type="1">
<li><p><strong>Save immediately</strong>: Write data inside the callback function, appending to a CSV each time</p></li>
<li><p><strong>Save at the end</strong>: Collect all data in memory for the entire study, then save everything once</p></li>
</ol>
<p>Both approaches have serious drawbacks. The first might slow down our callback function, potentially causing us to miss samples if the computer struggles with frequent file operations. The second approach avoids callback bottlenecks, but if Python crashes during the study (and trust me, it happens!), we’d lose <strong>all</strong> our precious data.</p>
<p><strong>The solution? A hybrid approach!</strong> We store data in memory but save it periodically during quieter moments - like the Inter-Stimulus Interval (ISI) between trials. This timing is perfect because participants are resting anyway.</p>
<section id="the-buffer-swap-technique" class="level3">
<h3 class="anchored" data-anchor-id="the-buffer-swap-technique">The Buffer Swap Technique</h3>
<p>The key challenge is avoiding data duplication when we save repeatedly. We need a way to save current data without affecting ongoing data collection.</p>
<p>Our solution uses a <strong>buffer swap</strong>:</p>
<p>Now we need to save our data efficiently. The key challenge is avoiding duplicate data - we don’t want to save the same samples multiple times when we call our save function repeatedly.</p>
<p>Our solution is simple: <strong>we can add our sample to a list and once we want to save we can switch it with a new e,pty one!!!</strong> Here, let me show how:</p>
<div id="9dfd8c06" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Swap buffers</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>saving_data, gaze_data_buffer <span class="op">=</span> gaze_data_buffer, []</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>saving_events, Events <span class="op">=</span> Events, []</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s what happens in this single line:</p>
<ul>
<li><p><code>gaze_data_buffer</code> (full of samples) gets copied to <code>saving_data</code></p></li>
<li><p><code>gaze_data_buffer</code> simultaneously becomes a fresh, empty list</p></li>
<li><p>The same happens for our Events</p></li>
</ul>
<p><strong>Why this works</strong>: This happens instantly in one step, so we don’t lose any data. While we’re saving the old samples, new samples keep getting collected in the fresh, empty list.</p>
<p>Now we can safely process and save <code>saving_data</code> and <code>saving_events</code> while data collection continues uninterrupted in the background.</p>
</section>
<section id="align-events-and-data" class="level3">
<h3 class="anchored" data-anchor-id="align-events-and-data">Align events and data</h3>
<p>Next, we need to match up our events with the eye tracking data. First, let’s turn our lists into dataframes to make them easier to work with:</p>
<div id="301bf4e3" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert lists to dataframes</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>data_df <span class="op">=</span> pd.DataFrame(saving_data)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>events_df <span class="op">=</span> pd.DataFrame(saving_events)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now comes the tricky part: our events and eye tracking data have different timestamps, but we want to know what event was happening during each eye tracking sample.</p>
<p>Think of it like this: imagine you have a timeline of eye tracking samples (every few milliseconds) and a few event markers (like “stimulus appeared”). We need to figure out which eye tracking samples happened during each event.</p>
<div id="4f91aa1e" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the closest eye tracking sample for each event</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> np.searchsorted(data_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                      events_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                      side<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Add event labels to our eye tracking data</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>data_df[<span class="st">'events'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>data_df.loc[idx, <span class="st">'events'</span>] <span class="op">=</span> events_df[<span class="st">'label'</span>].values  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>searchsorted</code> function looks at all our eye tracking timestamps and finds where each event timestamp would fit in. It’s like inserting event markers into our timeline of eye tracking data.</p>
<p>Now each row of eye tracking data shows what was happening at that moment! This wasn’t so hard, was it?</p>
<p>I’d recommend putting this whole process in a function so you can easily save your data whenever needed:ù</p>
<div id="580bc451" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving function</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_buffer_to_file(filename):</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer, Events</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if there are data</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gaze_data_buffer:</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Swap buffers - get current data and start fresh</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    saving_data, gaze_data_buffer <span class="op">=</span> gaze_data_buffer, []</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    saving_events, Events <span class="op">=</span> Events, []</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert lists to dataframes</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> pd.DataFrame(saving_data)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    events_df <span class="op">=</span> pd.DataFrame(saving_events)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match events with eye tracking data</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.searchsorted(data_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                          events_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                          side<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add event labels to our eye tracking data</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'events'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    data_df.loc[idx, <span class="st">'events'</span>] <span class="op">=</span> events_df[<span class="st">'label'</span>].values</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save to CSV file (append mode so we don't overwrite previous saves)</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    data_df.to_csv(filename, mode<span class="op">=</span><span class="st">'a'</span>, index<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>                   header<span class="op">=</span><span class="kw">not</span> os.path.isfile(filename))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function automatically grabs all the current data, swaps it with fresh empty lists, and saves everything. The <code>mode='a'</code> parameter tells pandas to append new data to the end of an existing file rather than overwriting it. This is perfect for our incremental saving approach since each time we save, we add new rows to our growing CSV file instead of losing previous data.</p>
<p>The <code>header=not os.path.isfile(filename)</code> part is a clever trick that writes column headers only when creating a new file. This prevents duplicate headers from appearing throughout your data file every time you save.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You could also save gaze data and events as separate CSV files during collection, then align and merge them during analysis.</p>
<p>However, we prefer combining them immediately for two reasons: it eliminates an extra step later, and it creates cleaner data files for the upcoming tutorials. Both approaches are perfectly valid - choose whichever fits your workflow better. If you’re just starting out, combining them now will make your life easier down the road.</p>
</div>
</div>
</section>
</section>
<section id="clean-and-prepare-your-data" class="level2">
<h2 class="anchored" data-anchor-id="clean-and-prepare-your-data">Clean and Prepare Your Data</h2>
<p>Great! Now you know how to collect eye tracking data and save it with events. Let’s add a few steps that will make your data much easier to work with and analyze.</p>
</section>
<section id="split-gaze-coordinates-into-separate-columns" class="level2">
<h2 class="anchored" data-anchor-id="split-gaze-coordinates-into-separate-columns">Split Gaze Coordinates into Separate Columns</h2>
<p>When we save gaze data, coordinate pairs like <code>'left_gaze_point_on_display_area': (0.463, 0.487)</code> become single columns containing tuples. This makes analysis difficult - you can’t easily plot or calculate with x and y values when they’re stuck together. We need separate columns for x and y coordinates for each eye.</p>
<p>Let’s update our save function:</p>
<div id="8f67de06" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save function</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_buffer_to_file(filename):</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer, Events</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if there are data</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gaze_data_buffer:</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Swap buffers - get current data and start fresh</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    saving_data, gaze_data_buffer <span class="op">=</span> gaze_data_buffer, []</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    saving_events, Events <span class="op">=</span> Events, []</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert lists to dataframes</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> pd.DataFrame(saving_data)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    events_df <span class="op">=</span> pd.DataFrame(saving_events)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match events with eye tracking data</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.searchsorted(data_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                          events_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                          side<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'events'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    data_df.loc[idx, <span class="st">'events'</span>] <span class="op">=</span> events_df[<span class="st">'label'</span>].values</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split coordinate tuples into separate columns</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'left_x'</span>, <span class="st">'left_y'</span>]] <span class="op">=</span> data_df[<span class="st">'left_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'right_x'</span>, <span class="st">'right_y'</span>]] <span class="op">=</span> data_df[<span class="st">'right_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save to CSV</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    data_df.to_csv(filename, mode<span class="op">=</span><span class="st">'a'</span>, index<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>                   header<span class="op">=</span><span class="kw">not</span> os.path.isfile(filename))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Perfect! Now we have separate x and y columns for both eyes, making analysis much easier.</p>
<section id="adjust-the-data" class="level3">
<h3 class="anchored" data-anchor-id="adjust-the-data">Adjust the Data</h3>
<p>The Tobii eye tracker gives us coordinates from 0 to 1, where (0, 0) is the top-left corner of the screen and (1, 1) is the bottom-right corner.</p>
<p>While this works fine, it can be confusing during analysis because most plotting systems expect the origin in the bottom-left corner, not the top-left. The image below shows this difference:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../..\images/CreateAnEyetrackingExperiment/Origins.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="419"></p>
</figure>
</div>
<p>Let’s adjust our data to make it more analysis-friendly:</p>
<ul>
<li><p><strong>Flip the y-axis</strong>: Move the origin to bottom-left by flipping y coordinates</p></li>
<li><p><strong>Convert to pixels</strong>: Change from 0-1 coordinates to actual pixel positions</p></li>
<li><p><strong>Simplify timestamps</strong>: Convert from microseconds to milliseconds</p></li>
<li><p><strong>Clean up column names</strong>: Make them shorter and more intuitive</p></li>
</ul>
<p>Here’s our updated function:</p>
<div id="8306472a" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Screen dimensions (replace with your actual screen size)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>winsize <span class="op">=</span> [<span class="dv">1920</span>, <span class="dv">1080</span>]  <span class="co"># width, height in pixels</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_buffer_to_file(filename):</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer, Events</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if there are data</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gaze_data_buffer:</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Swap buffers - get current data and start fresh</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    saving_data, gaze_data_buffer <span class="op">=</span> gaze_data_buffer, []</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    saving_events, Events <span class="op">=</span> Events, []</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert lists to dataframes</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> pd.DataFrame(saving_data)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    events_df <span class="op">=</span> pd.DataFrame(saving_events)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match events with eye tracking data</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.searchsorted(data_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>                          events_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>                          side<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'events'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    data_df.loc[idx, <span class="st">'events'</span>] <span class="op">=</span> events_df[<span class="st">'label'</span>].values</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split coordinate tuples into separate columns</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'left_x'</span>, <span class="st">'left_y'</span>]] <span class="op">=</span> data_df[<span class="st">'left_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'right_x'</span>, <span class="st">'right_y'</span>]] <span class="op">=</span> data_df[<span class="st">'right_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert and adjust coordinates</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'time'</span>] <span class="op">=</span> data_df[<span class="st">'system_time_stamp'</span>] <span class="op">/</span> <span class="fl">1000.0</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'left_x'</span>] <span class="op">=</span> data_df[<span class="st">'left_x'</span>] <span class="op">*</span> winsize[<span class="dv">0</span>]</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'left_y'</span>] <span class="op">=</span> winsize[<span class="dv">1</span>] <span class="op">-</span> data_df[<span class="st">'left_y'</span>] <span class="op">*</span> winsize[<span class="dv">1</span>]  <span class="co"># Flip y-axis</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'right_x'</span>] <span class="op">=</span> data_df[<span class="st">'right_x'</span>] <span class="op">*</span> winsize[<span class="dv">0</span>]</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'right_y'</span>] <span class="op">=</span> winsize[<span class="dv">1</span>] <span class="op">-</span> data_df[<span class="st">'right_y'</span>] <span class="op">*</span> winsize[<span class="dv">1</span>]  <span class="co"># Flip y-axis</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename columns for clarity</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> data_df.rename(columns<span class="op">=</span>{</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_gaze_point_validity'</span>: <span class="st">'left_valid'</span>,</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_gaze_point_validity'</span>: <span class="st">'right_valid'</span>,</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_pupil_diameter'</span>: <span class="st">'left_pupil'</span>,</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_pupil_diameter'</span>: <span class="st">'right_pupil'</span>,</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_pupil_validity'</span>: <span class="st">'left_pupil_valid'</span>,</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_pupil_validity'</span>: <span class="st">'right_pupil_valid'</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep only essential columns</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> data_df[[<span class="st">'time'</span>, <span class="st">'left_x'</span>, <span class="st">'left_y'</span>, <span class="st">'left_valid'</span>, <span class="st">'left_pupil'</span>, <span class="st">'left_pupil_valid'</span>,</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'right_x'</span>, <span class="st">'right_y'</span>, <span class="st">'right_valid'</span>, <span class="st">'right_pupil'</span>, <span class="st">'right_pupil_valid'</span>, <span class="st">'events'</span>]]</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save to CSV</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    data_df.to_csv(filename, mode<span class="op">=</span><span class="st">'a'</span>, index<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>                   header<span class="op">=</span><span class="kw">not</span> os.path.isfile(filename))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now our data is in pixel coordinates with the origin at the bottom-left, making it much easier to analyze and visualize!</p>
</section>
</section>
</section>
<section id="create-the-actual-experiment" class="level1">
<h1>Create the Actual Experiment</h1>
<p>Now we have two functions: one to collect eye tracking data and another to save it to CSV. Let’s see how to use these in our actual study.</p>
<section id="short-recap-of-the-paradigm" class="level2">
<h2 class="anchored" data-anchor-id="short-recap-of-the-paradigm">Short Recap of the Paradigm</h2>
<p>We’ll use the experimental design from <a href="../../CONTENT/GettingStarted/GettingStartedWithPsychopy.html">Getting started with PsychoPy</a> and add eye tracking to it. If you need a refresher on the paradigm, take a quick look at that tutorial.</p>
<p>Here’s a brief summary: After a fixation cross, participants see either a circle or square. The circle predicts a complex shape that will appear on the right side of the screen, while the square predicts a simple shape will on the left.</p>
</section>
<section id="putting-it-all-together" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-all-together">Putting It All Together</h2>
<p>Let’s build the complete experiment step by step.</p>
<section id="import-libraries-and-define-functions" class="level3">
<h3 class="anchored" data-anchor-id="import-libraries-and-define-functions">Import Libraries and Define Functions</h3>
<p>First, let’s import our libraries and define the functions we created earlier:</p>
<div id="efa957e4" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Import PsychoPy libraries</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> psychopy <span class="im">import</span> core, event, visual, sound</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tobii_research <span class="im">as</span> tr</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Functions</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Screen dimensions</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>winsize <span class="op">=</span> [<span class="dv">1920</span>, <span class="dv">1080</span>]  <span class="co"># width, height in pixels</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># This will be called every time there is new gaze data</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaze_data_callback(gaze_data):</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    gaze_data_buffer.append(gaze_data)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_buffer_to_file(filename):</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer, Events</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gaze_data_buffer:</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Swap buffers - get current data and start fresh</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    saving_data, gaze_data_buffer <span class="op">=</span> gaze_data_buffer, []</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    saving_events, Events <span class="op">=</span> Events, []</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert lists to dataframes</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> pd.DataFrame(saving_data)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    events_df <span class="op">=</span> pd.DataFrame(saving_events)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match events with eye tracking data</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.searchsorted(data_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>                          events_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>                          side<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'events'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    data_df.loc[idx, <span class="st">'events'</span>] <span class="op">=</span> events_df[<span class="st">'label'</span>].values</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split coordinate tuples into separate columns</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'left_x'</span>, <span class="st">'left_y'</span>]] <span class="op">=</span> data_df[<span class="st">'left_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'right_x'</span>, <span class="st">'right_y'</span>]] <span class="op">=</span> data_df[<span class="st">'right_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert and adjust coordinates</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'time'</span>] <span class="op">=</span> data_df[<span class="st">'system_time_stamp'</span>] <span class="op">/</span> <span class="fl">1000.0</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'left_x'</span>] <span class="op">=</span> data_df[<span class="st">'left_x'</span>] <span class="op">*</span> winsize[<span class="dv">0</span>]</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'left_y'</span>] <span class="op">=</span> winsize[<span class="dv">1</span>] <span class="op">-</span> data_df[<span class="st">'left_y'</span>] <span class="op">*</span> winsize[<span class="dv">1</span>]  <span class="co"># Flip y-axis</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'right_x'</span>] <span class="op">=</span> data_df[<span class="st">'right_x'</span>] <span class="op">*</span> winsize[<span class="dv">0</span>]</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'right_y'</span>] <span class="op">=</span> winsize[<span class="dv">1</span>] <span class="op">-</span> data_df[<span class="st">'right_y'</span>] <span class="op">*</span> winsize[<span class="dv">1</span>]  <span class="co"># Flip y-axis</span></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename columns for clarity</span></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> data_df.rename(columns<span class="op">=</span>{</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_gaze_point_validity'</span>: <span class="st">'left_valid'</span>,</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_gaze_point_validity'</span>: <span class="st">'right_valid'</span>,</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_pupil_diameter'</span>: <span class="st">'left_pupil'</span>,</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_pupil_diameter'</span>: <span class="st">'right_pupil'</span>,</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_pupil_validity'</span>: <span class="st">'left_pupil_valid'</span>,</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_pupil_validity'</span>: <span class="st">'right_pupil_valid'</span></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep only essential columns</span></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> data_df[[<span class="st">'time'</span>, <span class="st">'left_x'</span>, <span class="st">'left_y'</span>, <span class="st">'left_valid'</span>, <span class="st">'left_pupil'</span>, <span class="st">'left_pupil_valid'</span>,</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'right_x'</span>, <span class="st">'right_y'</span>, <span class="st">'right_valid'</span>, <span class="st">'right_pupil'</span>, <span class="st">'right_pupil_valid'</span>, <span class="st">'events'</span>]]</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save to CSV</span></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>    data_df.to_csv(filename, mode<span class="op">=</span><span class="st">'a'</span>, index<span class="op">=</span><span class="va">False</span>, header<span class="op">=</span><span class="kw">not</span> os.path.isfile(filename))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-the-stimuli" class="level3">
<h3 class="anchored" data-anchor-id="load-the-stimuli">Load the Stimuli</h3>
<p>Now let’s set up our experiment window and load all the stimuli. This part is identical to our previous PsychoPy tutorial:</p>
<div id="989ef5c2" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Load and prepare stimuli</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting the directory of our experiment</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>os.chdir(<span class="vs">r'&lt;&lt;&lt; YOUR PATH &gt;&gt;&gt;&gt;'</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Now create a Path object for the stimuli directory</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>stimuli_dir <span class="op">=</span> Path(<span class="st">'EXP'</span>) <span class="op">/</span> <span class="st">'Stimuli'</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load images </span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>fixation <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'fixation.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>circle <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'circle.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>square <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'square.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="bu">complex</span> <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'complex.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>), pos<span class="op">=</span>(<span class="dv">250</span>, <span class="dv">0</span>))</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>simple <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'simple.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>), pos<span class="op">=</span>(<span class="op">-</span><span class="dv">250</span>, <span class="dv">0</span>))</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Load sound </span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>presentation_sound <span class="op">=</span> sound.Sound(<span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'presentation.wav'</span>))</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co"># List of stimuli</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>cues <span class="op">=</span> [circle, square] <span class="co"># put both cues in a list</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>targets <span class="op">=</span> [<span class="bu">complex</span>, simple] <span class="co"># put both rewards in a list</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of trials in which 0 means winning and 1 means losing</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>Trials <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span> ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="start-recording" class="level3">
<h3 class="anchored" data-anchor-id="start-recording">Start recording</h3>
<p>Now we’re ready to find eye trackers connected to the computer and start collecting data. We’ll use the first eye tracker we find and launch our callback function to begin data collection.</p>
<div id="885ad028" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Record the data</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Find all connected eye trackers</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>found_eyetrackers <span class="op">=</span> tr.find_all_eyetrackers()</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># We will just use the first one</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>Eyetracker <span class="op">=</span> found_eyetrackers[<span class="dv">0</span>]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create our data buffers</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>gaze_data_buffer <span class="op">=</span> []</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>Events <span class="op">=</span> []</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Start recording</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>Eyetracker.subscribe_to(tr.EYETRACKER_GAZE_DATA, gaze_data_callback)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="present-our-stimuli" class="level3">
<h3 class="anchored" data-anchor-id="present-our-stimuli">Present Our Stimuli</h3>
<p>The eye tracking is running! Let’s show our participant something!</p>
<p>Notice that after each time we flip our window (which actually displays what we drew), we add an event to our Events list with a timestamp and label. This marks exactly when each stimulus appeared.</p>
<div id="6d1f4f7f" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Trials</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trial <span class="kw">in</span> Trials:</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Present the fixation</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    win.flip()  <span class="co"># Clear the window</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    fixation.draw()</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Fixation'</span>})</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">1</span>)  <span class="co"># Wait for 1 second</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Present the cue</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    cues[trial].draw()</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> trial <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Circle'</span>})</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Square'</span>})</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">3</span>)  <span class="co"># Wait for 3 seconds</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Wait for saccadic latency</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="fl">0.75</span>)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Present the target</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    targets[trial].draw()</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> trial <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Complex'</span>})</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Simple'</span>})</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    presentation_sound.play()</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">2</span>)  <span class="co"># Wait for 2 seconds</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">### ISI and save data</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    clock <span class="op">=</span> core.Clock()  <span class="co"># start the clock</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    write_buffer_to_file(gaze_data_buffer, Path(<span class="st">'DATA'</span>) <span class="op">/</span> <span class="st">'RAW'</span> <span class="op">/</span> (Sub <span class="op">+</span> <span class="st">'.csv'</span>))</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">1</span> <span class="op">-</span> clock.getTime()) <span class="co"># wait for remaining time</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Check for escape key to exit</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    keys <span class="op">=</span> event.getKeys()</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'escape'</span> <span class="kw">in</span> keys:</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>        win.close()</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>        Eyetracker.unsubscribe_from(tr.EYETRACKER_GAZE_DATA, gaze_data_callback)</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>        core.quit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we said before in [Save the data], it’s best to save data during our study to avoid potential data loss. It’s better to do this when there are things of minor interest, such as during the ISI. If you remember from the previous tutorial <a href="../../CONTENT/GettingStarted/GettingStartedWithPsychopy.html">Getting started with Psychopy</a>, we created the ISI in a different way than just using <code>core.wait()</code>, and we said that this different method would come in handy later on. This is the moment!</p>
<p>Our ISI starts the clock and saves the data immediately. After saving, we calculate how much time remains to reach the full 1-second duration and use core.wait() for any remaining time. This ensures we wait for exactly 1 second total, accounting for the time spent saving data.</p>
<div id="c0e5aadd" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">### ISI and save data</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>win.flip()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>clock <span class="op">=</span> core.Clock()  <span class="co"># start the clock</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>write_buffer_to_file(gaze_data_buffer, Path(<span class="st">'DATA'</span>) <span class="op">/</span> <span class="st">'RAW'</span> <span class="op">/</span> (Sub <span class="op">+</span> <span class="st">'.csv'</span>))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>core.wait(<span class="dv">1</span> <span class="op">-</span> clock.getTime()) <span class="co"># wait for remaining time</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Careful!!!<br>
If saving the data takes more than 1 second, your&nbsp;ISI&nbsp;will also be longer. However, this should not be the case with typical studies where trials are not too long. Nonetheless, it’s always a good idea to keep an eye out.</p>
</div>
</div>
</section>
<section id="stop-recording" class="level3">
<h3 class="anchored" data-anchor-id="stop-recording">Stop recording</h3>
<p>Almost done! We’ve collected data, sent events, and saved everything. The final step is to stop data collection (otherwise Python will keep getting endless data from the eye tracker!). We simply unsubscribe from the eye tracker:</p>
<div id="219aa184" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Final save to catch any remaining data</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>write_buffer_to_file(Path(<span class="st">'DATA'</span>) <span class="op">/</span> <span class="st">'RAW'</span> <span class="op">/</span> (Sub <span class="op">+</span> <span class="st">'.csv'</span>))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>win.close()  <span class="co"># Close the window</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>Eyetracker.unsubscribe_from(tr.EYETRACKER_GAZE_DATA, gaze_data_callback)  <span class="co"># Stop eye tracking</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>core.quit()  <span class="co"># End the study</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we also closed the Psychopy window, so that the stimulus presentation is also officially over. Well done!!! Now go and get your data!!! We’ll see you back when it’s time to analyze it.</p>
</section>
</section>
</section>
<section id="end" class="level1">
<h1>END!!</h1>
<p>Great job getting to here!! it want easy but you did it. Here is all the code we made together.</p>
<div id="6fd6f9e4" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Import PsychoPy libraries</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> psychopy <span class="im">import</span> core, event, visual, sound</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tobii_research <span class="im">as</span> tr</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Functions</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Screen dimensions</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>winsize <span class="op">=</span> [<span class="dv">1920</span>, <span class="dv">1080</span>]  <span class="co"># width, height in pixels</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co"># This will be called every time there is new gaze data</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaze_data_callback(gaze_data):</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    gaze_data_buffer.append(gaze_data)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_buffer_to_file(filename):</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer, Events</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if there are data</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gaze_data_buffer:</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Swap buffers - get current data and start fresh</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    saving_data, gaze_data_buffer <span class="op">=</span> gaze_data_buffer, []</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    saving_events, Events <span class="op">=</span> Events, []</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert lists to dataframes</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> pd.DataFrame(saving_data)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    events_df <span class="op">=</span> pd.DataFrame(saving_events)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match events with eye tracking data</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.searchsorted(data_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>                          events_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>                          side<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'events'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    data_df.loc[idx, <span class="st">'events'</span>] <span class="op">=</span> events_df[<span class="st">'label'</span>].values</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split coordinate tuples into separate columns</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'left_x'</span>, <span class="st">'left_y'</span>]] <span class="op">=</span> data_df[<span class="st">'left_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'right_x'</span>, <span class="st">'right_y'</span>]] <span class="op">=</span> data_df[<span class="st">'right_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert and adjust coordinates</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'time'</span>] <span class="op">=</span> data_df[<span class="st">'system_time_stamp'</span>] <span class="op">/</span> <span class="fl">1000.0</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'left_x'</span>] <span class="op">=</span> data_df[<span class="st">'left_x'</span>] <span class="op">*</span> winsize[<span class="dv">0</span>]</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'left_y'</span>] <span class="op">=</span> winsize[<span class="dv">1</span>] <span class="op">-</span> data_df[<span class="st">'left_y'</span>] <span class="op">*</span> winsize[<span class="dv">1</span>]  <span class="co"># Flip y-axis</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'right_x'</span>] <span class="op">=</span> data_df[<span class="st">'right_x'</span>] <span class="op">*</span> winsize[<span class="dv">0</span>]</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'right_y'</span>] <span class="op">=</span> winsize[<span class="dv">1</span>] <span class="op">-</span> data_df[<span class="st">'right_y'</span>] <span class="op">*</span> winsize[<span class="dv">1</span>]  <span class="co"># Flip y-axis</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename columns for clarity</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> data_df.rename(columns<span class="op">=</span>{</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_gaze_point_validity'</span>: <span class="st">'left_valid'</span>,</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_gaze_point_validity'</span>: <span class="st">'right_valid'</span>,</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_pupil_diameter'</span>: <span class="st">'left_pupil'</span>,</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_pupil_diameter'</span>: <span class="st">'right_pupil'</span>,</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_pupil_validity'</span>: <span class="st">'left_pupil_valid'</span>,</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_pupil_validity'</span>: <span class="st">'right_pupil_valid'</span></span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep only essential columns</span></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> data_df[[<span class="st">'time'</span>, <span class="st">'left_x'</span>, <span class="st">'left_y'</span>, <span class="st">'left_valid'</span>, <span class="st">'left_pupil'</span>, <span class="st">'left_pupil_valid'</span>,</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'right_x'</span>, <span class="st">'right_y'</span>, <span class="st">'right_valid'</span>, <span class="st">'right_pupil'</span>, <span class="st">'right_pupil_valid'</span>, <span class="st">'events'</span>]]</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save to CSV</span></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>    data_df.to_csv(filename, mode<span class="op">=</span><span class="st">'a'</span>, index<span class="op">=</span><span class="va">False</span>, header<span class="op">=</span><span class="kw">not</span> os.path.isfile(filename))</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Load and prepare stimuli</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting the directory of our experiment</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>os.chdir(<span class="vs">r'&lt;&lt;&lt; YOUR PATH &gt;&gt;&gt;&gt;'</span>)</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Now create a Path object for the stimuli directory</span></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>stimuli_dir <span class="op">=</span> Path(<span class="st">'EXP'</span>) <span class="op">/</span> <span class="st">'Stimuli'</span></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a window</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>win <span class="op">=</span> visual.Window(size<span class="op">=</span>winsize, fullscr<span class="op">=</span><span class="va">True</span>, units<span class="op">=</span><span class="st">"pix"</span>, pos<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">30</span>), screen<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Load images </span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>fixation <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'fixation.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>circle <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'circle.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>square <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'square.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a><span class="bu">complex</span> <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'complex.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>), pos<span class="op">=</span>(<span class="dv">250</span>, <span class="dv">0</span>))</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>simple <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'simple.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>), pos<span class="op">=</span>(<span class="op">-</span><span class="dv">250</span>, <span class="dv">0</span>))</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Load sound </span></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>presentation_sound <span class="op">=</span> sound.Sound(<span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'presentation.wav'</span>))</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a><span class="co"># List of stimuli</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>cues <span class="op">=</span> [circle, square] <span class="co"># put both cues in a list</span></span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>targets <span class="op">=</span> [<span class="bu">complex</span>, simple] <span class="co"># put both rewards in a list</span></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of trials in which 0 means winning and 1 means losing</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>Trials <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Record the data</span></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the subject name</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>Sub <span class="op">=</span> <span class="st">'S001'</span></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Find all connected eye trackers</span></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>found_eyetrackers <span class="op">=</span> tr.find_all_eyetrackers()</span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a><span class="co"># We will just use the first one</span></span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>Eyetracker <span class="op">=</span> found_eyetrackers[<span class="dv">0</span>]</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Create our data buffers</span></span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>gaze_data_buffer <span class="op">=</span> []</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>Events <span class="op">=</span> []</span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Start recording</span></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>Eyetracker.subscribe_to(tr.EYETRACKER_GAZE_DATA, gaze_data_callback)</span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Trials</span></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trial <span class="kw">in</span> Trials:</span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Present the fixation</span></span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>    win.flip() <span class="co"># we flip to clean the window</span></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>    fixation.draw()</span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>    Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Fixation'</span>})</span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">1</span>)  <span class="co"># wait for 1 second</span></span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Present the cue</span></span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>    cues[trial].draw()</span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> trial <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Circle'</span>})</span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Square'</span>})</span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">3</span>)  <span class="co"># wait for 3 seconds</span></span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Wait for saccadic latency</span></span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="fl">0.75</span>)</span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Present the targets</span></span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>    targets[trial].draw()</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> trial <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Complex'</span>})</span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Simple'</span>})</span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a>    presentation_sound.play()</span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">2</span>)  <span class="co"># wait for 2 seconds</span></span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>    <span class="co">### ISI and save data</span></span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>    clock <span class="op">=</span> core.Clock()  <span class="co"># start the clock</span></span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>    write_buffer_to_file(gaze_data_buffer, Path(<span class="st">'DATA'</span>) <span class="op">/</span> <span class="st">'RAW'</span> <span class="op">/</span> (Sub <span class="op">+</span> <span class="st">'.csv'</span>))</span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">1</span> <span class="op">-</span> clock.getTime()) <span class="co"># wait for remaining time</span></span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Check for closing experiment</span></span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>    keys <span class="op">=</span> event.getKeys() <span class="co"># collect list of pressed keys</span></span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'escape'</span> <span class="kw">in</span> keys:</span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a>        win.close()  <span class="co"># close window</span></span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>        Eyetracker.unsubscribe_from(tr.EYETRACKER_GAZE_DATA, gaze_data_callback)</span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a>        core.quit()  <span class="co"># stop study</span></span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Final save to catch any remaining data</span></span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>write_buffer_to_file(Path(<span class="st">'DATA'</span>) <span class="op">/</span> <span class="st">'RAW'</span> <span class="op">/</span> (Sub <span class="op">+</span> <span class="st">'.csv'</span>))</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a>win.close() <span class="co"># close window</span></span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a>Eyetracker.unsubscribe_from(tr.EYETRACKER_GAZE_DATA, gaze_data_callback) <span class="co"># unsubscribe eyetracking</span></span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a>core.quit() <span class="co"># stop study</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tommasoghilardi\.github\.io\/DevStart\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../CONTENT/EyeTracking/Intro_eyetracking.html" class="pagination-link" aria-label="Eye-tracking">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Eye-tracking</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../CONTENT/EyeTracking/EyetrackingCalibration.html" class="pagination-link" aria-label="Calibrating eye-tracking">
        <span class="nav-page-text">Calibrating eye-tracking</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb22" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Create an eye-tracking experiment"</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "05/20/2024"</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: false</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">  kernel: "python3"</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="an">author-meta:</span><span class="co"> "Tommaso Ghilardi, Francesco Poli"</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="an">description-meta:</span><span class="co"> "Learn how to record eyetracking data in your psychopy experiment using Tobii SDK, tobii_research"</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="an">keywords:</span><span class="co"> "PsychoPy, Python, eye-tracking, tobii, tobii_research, experimental psychology, tutorial, experiment, DevStart, developmental science"</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - Eye-tracking</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - Python</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>This page will show you how to collect eye-tracking data in a simple Psychopy paradigm. We will use the same paradigm that we built together in the <span class="co">[</span><span class="ot">Getting started with Psychopy</span><span class="co">](/CONTENT/GettingStarted/GettingStartedWithPsychopy.qmd)</span> tutorial. If you have not done that tutorial yet, please go through it first.</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>::: callout-caution</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>**Tobii eye-tracker**</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>Note that this tutorial is specific for using **Tobii eye-trackers**. The general steps and idea are obviously applicable to other eye-trackers, but the specific code and packages may vary.</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>**Our Approach**</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>The method we'll show you here is designed to be **simple and functional** rather than the most efficient or sophisticated approach possible. There are more advanced techniques for handling eye tracking data collection, buffer management, and event synchronization, but we've prioritized code that's easy to understand and modify.</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>Our goal is to get you up and running with a working eye tracking experiment that you can build upon. Once you're comfortable with these basics, you can always optimize and refine your approach for more demanding applications.</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="fu"># Tobii_sdk</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>To start, we will look into how to connect and talk to our Tobii eyetracker with the **SDK** that Tobii provides. An **SDK** is a collection of tools and programs for developing applications for a specific platform or device. We will use the **Python Tobii SDK** that lets us easily find and get data from our Tobii eye tracker.</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="fu">## Install</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>To install the Python Tobii SDK, we can simply run this command in our conda terminal:</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="in">``` bash</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install tobii_research</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>:::: {.info-box .info-box-large}</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>::: info-box-title</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>Compatibility older eye-trackers</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>If you're using an older Tobii eye-tracker, check the compatibility page to see which version of tobii_research you need for your specific model. Check it <span class="co">[</span><span class="ot">here</span><span class="co">](https://developer.tobiipro.com/tobiiprosdk/eyetrackercompatibility.html)</span>.</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>::::</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>Great! We have installed the Tobii SDK.</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a><span class="fu">## Connect to the eye-tracker</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>So how does this library work, how do we connect to the eye-tracker and collect our data? Very good questions!</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>The <span class="in">`tobii_research`</span> documentation is quite extensive and describes in detail a lot of functions and data classes that are very useful. However, we don't need much to start our experiment.</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>First we need to identify all the eye trackers connected to our computer. Yes, plural, <span class="in">`tobii_research`</span> will return a list of all the eye trackers connected to our computer. 99.99999999% of the time you will only have 1 eye tracker connected, so we can just select the first (and usually only) eye tracker found.</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Import tobii_research library</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tobii_research <span class="im">as</span> tr</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Find all connected eye trackers</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>found_eyetrackers <span class="op">=</span> tr.find_all_eyetrackers()</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a><span class="co"># We will just use the first one</span></span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>Eyetracker <span class="op">=</span> found_eyetrackers[<span class="dv">0</span>]</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>Perfect!! We have identified our eye-trackers, and we have selected the first one (and only).</span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>We are now ready to use our eye-tracker to collect some data... but how?</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a><span class="fu">## Collect data</span></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>Tobii_research has a cool way of telling us what data we are collecting at each time point. It uses a callback function. What is a callback function, you ask? It is a function that tobii runs each time it has a new data point. Let's say we have an eye tracker that collects data at 300Hz (300 samples per second): the function will be called every time the tobii has one of those 300 samples.</span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>This callback function will give us a <span class="in">`gaze_data`</span> dictionary. This dictionary contains multiple information of that collected sample</span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>Here is our callback function:</span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a><span class="co"># callback function</span></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaze_data_callback(gaze_data):</span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(gaze_data)</span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a>This will print the entire dictionary to your console. Here's what you'll see:</span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a><span class="in">``` python</span></span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a>{<span class="st">'device_time_stamp'</span>: <span class="dv">467525500</span>,</span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a> <span class="st">'system_time_stamp'</span>: <span class="dv">6405415231</span>,</span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_gaze_point_on_display_area'</span>: (<span class="fl">0.4633694291</span>, <span class="fl">0.4872185290</span>),</span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_gaze_point_in_user_coordinate_system'</span>: (<span class="op">-</span><span class="fl">10.15791702</span>, <span class="fl">128.29026794</span>, <span class="fl">40.876254</span>),</span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_gaze_point_validity'</span>: <span class="dv">1</span>,</span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_pupil_diameter'</span>: <span class="fl">5.655228</span>,</span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_pupil_validity'</span>: <span class="dv">1</span>,</span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_gaze_origin_in_user_coordinate_system'</span>: (<span class="op">-</span><span class="fl">25.86829758</span>, <span class="fl">1.41938722</span>, <span class="fl">644.839478</span>),</span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_gaze_origin_in_trackbox_coordinate_system'</span>: (<span class="fl">0.561557</span>, <span class="fl">0.481128</span>, <span class="fl">0.489121</span>),</span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a> <span class="st">'left_gaze_origin_validity'</span>: <span class="dv">1</span>,</span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_gaze_point_on_display_area'</span>: (<span class="fl">0.4944303632</span>, <span class="fl">0.4498708546</span>),</span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_gaze_point_in_user_coordinate_system'</span>: (<span class="fl">0.7905667424</span>, <span class="fl">135.2486572266</span>, <span class="fl">43.373546</span>),</span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_gaze_point_validity'</span>: <span class="dv">1</span>,</span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_pupil_diameter'</span>: <span class="fl">5.307220</span>,</span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_pupil_validity'</span>: <span class="dv">1</span>,</span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_gaze_origin_in_user_coordinate_system'</span>: (<span class="fl">32.52792358398</span>, <span class="op">-</span><span class="fl">2.97285223007</span>, <span class="fl">640.345520</span>),</span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_gaze_origin_in_trackbox_coordinate_system'</span>: (<span class="fl">0.431783</span>, <span class="fl">0.495703</span>, <span class="fl">0.483452</span>),</span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a> <span class="st">'right_gaze_origin_validity'</span>: <span class="dv">1</span>}</span>
<span id="cb22-116"><a href="#cb22-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-117"><a href="#cb22-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-118"><a href="#cb22-118" aria-hidden="true" tabindex="-1"></a>Wow! Look at all that data from just one sample!</span>
<span id="cb22-119"><a href="#cb22-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-120"><a href="#cb22-120" aria-hidden="true" tabindex="-1"></a>Now we need to tell the eye tracker to actually use our callback function. This part is super easy:</span>
<span id="cb22-121"><a href="#cb22-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-124"><a href="#cb22-124" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-125"><a href="#cb22-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Start the callback function</span></span>
<span id="cb22-126"><a href="#cb22-126" aria-hidden="true" tabindex="-1"></a>Eyetracker.subscribe_to(tr.EYETRACKER_GAZE_DATA, gaze_data_callback)</span>
<span id="cb22-127"><a href="#cb22-127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-128"><a href="#cb22-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-129"><a href="#cb22-129" aria-hidden="true" tabindex="-1"></a>What we're doing here is subscribing to the <span class="in">`EYETRACKER_GAZE_DATA`</span> stream and telling it to send all that data to our <span class="in">`gaze_data_callback`</span> function. Once this runs, your console will start flooding with data!</span>
<span id="cb22-130"><a href="#cb22-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-131"><a href="#cb22-131" aria-hidden="true" tabindex="-1"></a><span class="fu">### Global to save</span></span>
<span id="cb22-132"><a href="#cb22-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-133"><a href="#cb22-133" aria-hidden="true" tabindex="-1"></a>Great! You've set up a callback function that receives eye tracking data from your device. However, printing 300 data points per second to the console creates an unreadable stream of text that's not useful for analysis. We need to store this data properly.</span>
<span id="cb22-134"><a href="#cb22-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-135"><a href="#cb22-135" aria-hidden="true" tabindex="-1"></a>Let's create a list to collect all the gaze data:</span>
<span id="cb22-136"><a href="#cb22-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-139"><a href="#cb22-139" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-140"><a href="#cb22-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list we will append our data to</span></span>
<span id="cb22-141"><a href="#cb22-141" aria-hidden="true" tabindex="-1"></a>gaze_data_buffer <span class="op">=</span> []</span>
<span id="cb22-142"><a href="#cb22-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-143"><a href="#cb22-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-144"><a href="#cb22-144" aria-hidden="true" tabindex="-1"></a>Perfect! We've got our list to which we can append the incoming data. We can simply have this list inside of our callback function so every time an new sample appears it will be added there. This is how our script could look now:</span>
<span id="cb22-145"><a href="#cb22-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-148"><a href="#cb22-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-149"><a href="#cb22-149" aria-hidden="true" tabindex="-1"></a><span class="co"># callback function</span></span>
<span id="cb22-150"><a href="#cb22-150" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaze_data_callback(gaze_data):</span>
<span id="cb22-151"><a href="#cb22-151" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer</span>
<span id="cb22-152"><a href="#cb22-152" aria-hidden="true" tabindex="-1"></a>    gaze_data_buffer.append(gaze_data)</span>
<span id="cb22-153"><a href="#cb22-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-154"><a href="#cb22-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-155"><a href="#cb22-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list we will append our data to</span></span>
<span id="cb22-156"><a href="#cb22-156" aria-hidden="true" tabindex="-1"></a>gaze_data_buffer <span class="op">=</span> []</span>
<span id="cb22-157"><a href="#cb22-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-158"><a href="#cb22-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Start the callback function</span></span>
<span id="cb22-159"><a href="#cb22-159" aria-hidden="true" tabindex="-1"></a>Eyetracker.subscribe_to(tr.EYETRACKER_GAZE_DATA, gaze_data_callback, as_dictionary<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-160"><a href="#cb22-160" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-161"><a href="#cb22-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-162"><a href="#cb22-162" aria-hidden="true" tabindex="-1"></a>Notice the <span class="in">`global`</span> keyword in the callback function. This tells Python that we want to use the <span class="in">`gaze_data_buffer`</span> variable that was created outside the function. Without this keyword, Python may create a new local variable instead of using our existing list.</span>
<span id="cb22-163"><a href="#cb22-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-164"><a href="#cb22-164" aria-hidden="true" tabindex="-1"></a>Now instead of flooding the console, every new sample gets stored in our list for later analysis!</span>
<span id="cb22-165"><a href="#cb22-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-166"><a href="#cb22-166" aria-hidden="true" tabindex="-1"></a><span class="fu">## Triggers/Events</span></span>
<span id="cb22-167"><a href="#cb22-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-168"><a href="#cb22-168" aria-hidden="true" tabindex="-1"></a>As we've seen, our callback function can access Tobii data and process each sample. But there's one crucial piece missing: **we need to know exactly when we presented our stimuli**.</span>
<span id="cb22-169"><a href="#cb22-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-170"><a href="#cb22-170" aria-hidden="true" tabindex="-1"></a>In most studies, we present various stimuli - pictures, sounds, or videos. For meaningful analysis, we must know the precise timing of when each stimulus appeared.</span>
<span id="cb22-171"><a href="#cb22-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-172"><a href="#cb22-172" aria-hidden="true" tabindex="-1"></a>The Tobii SDK provides an elegant solution through the <span class="in">`tr.get_system_time_stamp()`</span> function. This function returns the current time using the same system clock that the eye tracker uses for its data timestamps. Remember that each gaze sample includes a <span class="in">`system_time_stamp`</span> field? This means we can perfectly synchronize our events with the gaze data.</span>
<span id="cb22-173"><a href="#cb22-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-174"><a href="#cb22-174" aria-hidden="true" tabindex="-1"></a>We can create a simple event-logging system by storing timestamps alongside descriptive labels:</span>
<span id="cb22-175"><a href="#cb22-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-178"><a href="#cb22-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-179"><a href="#cb22-179" aria-hidden="true" tabindex="-1"></a>Events <span class="op">=</span> [] <span class="co"># create empty list</span></span>
<span id="cb22-180"><a href="#cb22-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-181"><a href="#cb22-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the current time from the eye-tracker's clock</span></span>
<span id="cb22-182"><a href="#cb22-182" aria-hidden="true" tabindex="-1"></a>Events.append({<span class="st">'system_time_stamp'</span>:  tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Our First event!!'</span>})</span>
<span id="cb22-183"><a href="#cb22-183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-184"><a href="#cb22-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-185"><a href="#cb22-185" aria-hidden="true" tabindex="-1"></a><span class="fu">## Save the data</span></span>
<span id="cb22-186"><a href="#cb22-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-187"><a href="#cb22-187" aria-hidden="true" tabindex="-1"></a>Perfect! Now we have two lists containing all our information. They grow continuously (especially the <span class="in">`gaze_data_buffer`</span>) and we need an efficient way to save them.</span>
<span id="cb22-188"><a href="#cb22-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-189"><a href="#cb22-189" aria-hidden="true" tabindex="-1"></a>There are two common approaches:</span>
<span id="cb22-190"><a href="#cb22-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-191"><a href="#cb22-191" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Save immediately**: Write data inside the callback function, appending to a CSV each time</span>
<span id="cb22-192"><a href="#cb22-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-193"><a href="#cb22-193" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Save at the end**: Collect all data in memory for the entire study, then save everything once</span>
<span id="cb22-194"><a href="#cb22-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-195"><a href="#cb22-195" aria-hidden="true" tabindex="-1"></a>Both approaches have serious drawbacks. The first might slow down our callback function, potentially causing us to miss samples if the computer struggles with frequent file operations. The second approach avoids callback bottlenecks, but if Python crashes during the study (and trust me, it happens!), we'd lose **all** our precious data.</span>
<span id="cb22-196"><a href="#cb22-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-197"><a href="#cb22-197" aria-hidden="true" tabindex="-1"></a>**The solution? A hybrid approach!** We store data in memory but save it periodically during quieter moments - like the Inter-Stimulus Interval (ISI) between trials. This timing is perfect because participants are resting anyway.</span>
<span id="cb22-198"><a href="#cb22-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-199"><a href="#cb22-199" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Buffer Swap Technique</span></span>
<span id="cb22-200"><a href="#cb22-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-201"><a href="#cb22-201" aria-hidden="true" tabindex="-1"></a>The key challenge is avoiding data duplication when we save repeatedly. We need a way to save current data without affecting ongoing data collection.</span>
<span id="cb22-202"><a href="#cb22-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-203"><a href="#cb22-203" aria-hidden="true" tabindex="-1"></a>Our solution uses a **buffer swap**:</span>
<span id="cb22-204"><a href="#cb22-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-205"><a href="#cb22-205" aria-hidden="true" tabindex="-1"></a>Now we need to save our data efficiently. The key challenge is avoiding duplicate data - we don't want to save the same samples multiple times when we call our save function repeatedly.</span>
<span id="cb22-206"><a href="#cb22-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-207"><a href="#cb22-207" aria-hidden="true" tabindex="-1"></a>Our solution is simple: **we can add our sample to a list and once we want to save we can switch it with a new e,pty one!!!** Here, let me show how:</span>
<span id="cb22-208"><a href="#cb22-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-211"><a href="#cb22-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-212"><a href="#cb22-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Swap buffers</span></span>
<span id="cb22-213"><a href="#cb22-213" aria-hidden="true" tabindex="-1"></a>saving_data, gaze_data_buffer <span class="op">=</span> gaze_data_buffer, []</span>
<span id="cb22-214"><a href="#cb22-214" aria-hidden="true" tabindex="-1"></a>saving_events, Events <span class="op">=</span> Events, []</span>
<span id="cb22-215"><a href="#cb22-215" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-216"><a href="#cb22-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-217"><a href="#cb22-217" aria-hidden="true" tabindex="-1"></a>Here's what happens in this single line:</span>
<span id="cb22-218"><a href="#cb22-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-219"><a href="#cb22-219" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`gaze_data_buffer`</span> (full of samples) gets copied to <span class="in">`saving_data`</span></span>
<span id="cb22-220"><a href="#cb22-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-221"><a href="#cb22-221" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`gaze_data_buffer`</span> simultaneously becomes a fresh, empty list</span>
<span id="cb22-222"><a href="#cb22-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-223"><a href="#cb22-223" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The same happens for our Events</span>
<span id="cb22-224"><a href="#cb22-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-225"><a href="#cb22-225" aria-hidden="true" tabindex="-1"></a>**Why this works**: This happens instantly in one step, so we don't lose any data. While we're saving the old samples, new samples keep getting collected in the fresh, empty list.</span>
<span id="cb22-226"><a href="#cb22-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-227"><a href="#cb22-227" aria-hidden="true" tabindex="-1"></a>Now we can safely process and save <span class="in">`saving_data`</span> and <span class="in">`saving_events`</span> while data collection continues uninterrupted in the background.</span>
<span id="cb22-228"><a href="#cb22-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-229"><a href="#cb22-229" aria-hidden="true" tabindex="-1"></a><span class="fu">### Align events and data</span></span>
<span id="cb22-230"><a href="#cb22-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-231"><a href="#cb22-231" aria-hidden="true" tabindex="-1"></a>Next, we need to match up our events with the eye tracking data. First, let's turn our lists into dataframes to make them easier to work with:</span>
<span id="cb22-232"><a href="#cb22-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-235"><a href="#cb22-235" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-236"><a href="#cb22-236" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert lists to dataframes</span></span>
<span id="cb22-237"><a href="#cb22-237" aria-hidden="true" tabindex="-1"></a>data_df <span class="op">=</span> pd.DataFrame(saving_data)</span>
<span id="cb22-238"><a href="#cb22-238" aria-hidden="true" tabindex="-1"></a>events_df <span class="op">=</span> pd.DataFrame(saving_events)</span>
<span id="cb22-239"><a href="#cb22-239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-240"><a href="#cb22-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-241"><a href="#cb22-241" aria-hidden="true" tabindex="-1"></a>Now comes the tricky part: our events and eye tracking data have different timestamps, but we want to know what event was happening during each eye tracking sample.</span>
<span id="cb22-242"><a href="#cb22-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-243"><a href="#cb22-243" aria-hidden="true" tabindex="-1"></a>Think of it like this: imagine you have a timeline of eye tracking samples (every few milliseconds) and a few event markers (like "stimulus appeared"). We need to figure out which eye tracking samples happened during each event.</span>
<span id="cb22-244"><a href="#cb22-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-247"><a href="#cb22-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-248"><a href="#cb22-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the closest eye tracking sample for each event</span></span>
<span id="cb22-249"><a href="#cb22-249" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> np.searchsorted(data_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb22-250"><a href="#cb22-250" aria-hidden="true" tabindex="-1"></a>                      events_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb22-251"><a href="#cb22-251" aria-hidden="true" tabindex="-1"></a>                      side<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb22-252"><a href="#cb22-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-253"><a href="#cb22-253" aria-hidden="true" tabindex="-1"></a><span class="co"># Add event labels to our eye tracking data</span></span>
<span id="cb22-254"><a href="#cb22-254" aria-hidden="true" tabindex="-1"></a>data_df[<span class="st">'events'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb22-255"><a href="#cb22-255" aria-hidden="true" tabindex="-1"></a>data_df.loc[idx, <span class="st">'events'</span>] <span class="op">=</span> events_df[<span class="st">'label'</span>].values  </span>
<span id="cb22-256"><a href="#cb22-256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-257"><a href="#cb22-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-258"><a href="#cb22-258" aria-hidden="true" tabindex="-1"></a>The <span class="in">`searchsorted`</span> function looks at all our eye tracking timestamps and finds where each event timestamp would fit in. It's like inserting event markers into our timeline of eye tracking data.</span>
<span id="cb22-259"><a href="#cb22-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-260"><a href="#cb22-260" aria-hidden="true" tabindex="-1"></a>Now each row of eye tracking data shows what was happening at that moment! This wasn't so hard, was it?</span>
<span id="cb22-261"><a href="#cb22-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-262"><a href="#cb22-262" aria-hidden="true" tabindex="-1"></a>I'd recommend putting this whole process in a function so you can easily save your data whenever needed:ù</span>
<span id="cb22-263"><a href="#cb22-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-266"><a href="#cb22-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-267"><a href="#cb22-267" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving function</span></span>
<span id="cb22-268"><a href="#cb22-268" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_buffer_to_file(filename):</span>
<span id="cb22-269"><a href="#cb22-269" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer, Events</span>
<span id="cb22-270"><a href="#cb22-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-271"><a href="#cb22-271" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if there are data</span></span>
<span id="cb22-272"><a href="#cb22-272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gaze_data_buffer:</span>
<span id="cb22-273"><a href="#cb22-273" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb22-274"><a href="#cb22-274" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-275"><a href="#cb22-275" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Swap buffers - get current data and start fresh</span></span>
<span id="cb22-276"><a href="#cb22-276" aria-hidden="true" tabindex="-1"></a>    saving_data, gaze_data_buffer <span class="op">=</span> gaze_data_buffer, []</span>
<span id="cb22-277"><a href="#cb22-277" aria-hidden="true" tabindex="-1"></a>    saving_events, Events <span class="op">=</span> Events, []</span>
<span id="cb22-278"><a href="#cb22-278" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-279"><a href="#cb22-279" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert lists to dataframes</span></span>
<span id="cb22-280"><a href="#cb22-280" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> pd.DataFrame(saving_data)</span>
<span id="cb22-281"><a href="#cb22-281" aria-hidden="true" tabindex="-1"></a>    events_df <span class="op">=</span> pd.DataFrame(saving_events)</span>
<span id="cb22-282"><a href="#cb22-282" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-283"><a href="#cb22-283" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match events with eye tracking data</span></span>
<span id="cb22-284"><a href="#cb22-284" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.searchsorted(data_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb22-285"><a href="#cb22-285" aria-hidden="true" tabindex="-1"></a>                          events_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb22-286"><a href="#cb22-286" aria-hidden="true" tabindex="-1"></a>                          side<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb22-287"><a href="#cb22-287" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add event labels to our eye tracking data</span></span>
<span id="cb22-288"><a href="#cb22-288" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'events'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb22-289"><a href="#cb22-289" aria-hidden="true" tabindex="-1"></a>    data_df.loc[idx, <span class="st">'events'</span>] <span class="op">=</span> events_df[<span class="st">'label'</span>].values</span>
<span id="cb22-290"><a href="#cb22-290" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-291"><a href="#cb22-291" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save to CSV file (append mode so we don't overwrite previous saves)</span></span>
<span id="cb22-292"><a href="#cb22-292" aria-hidden="true" tabindex="-1"></a>    data_df.to_csv(filename, mode<span class="op">=</span><span class="st">'a'</span>, index<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb22-293"><a href="#cb22-293" aria-hidden="true" tabindex="-1"></a>                   header<span class="op">=</span><span class="kw">not</span> os.path.isfile(filename))</span>
<span id="cb22-294"><a href="#cb22-294" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-295"><a href="#cb22-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-296"><a href="#cb22-296" aria-hidden="true" tabindex="-1"></a>This function automatically grabs all the current data, swaps it with fresh empty lists, and saves everything. The <span class="in">`mode='a'`</span> parameter tells pandas to append new data to the end of an existing file rather than overwriting it. This is perfect for our incremental saving approach since each time we save, we add new rows to our growing CSV file instead of losing previous data.</span>
<span id="cb22-297"><a href="#cb22-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-298"><a href="#cb22-298" aria-hidden="true" tabindex="-1"></a>The <span class="in">`header=not os.path.isfile(filename)`</span> part is a clever trick that writes column headers only when creating a new file. This prevents duplicate headers from appearing throughout your data file every time you save.</span>
<span id="cb22-299"><a href="#cb22-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-300"><a href="#cb22-300" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb22-301"><a href="#cb22-301" aria-hidden="true" tabindex="-1"></a>You could also save gaze data and events as separate CSV files during collection, then align and merge them during analysis.</span>
<span id="cb22-302"><a href="#cb22-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-303"><a href="#cb22-303" aria-hidden="true" tabindex="-1"></a>However, we prefer combining them immediately for two reasons: it eliminates an extra step later, and it creates cleaner data files for the upcoming tutorials. Both approaches are perfectly valid - choose whichever fits your workflow better. If you're just starting out, combining them now will make your life easier down the road.</span>
<span id="cb22-304"><a href="#cb22-304" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb22-305"><a href="#cb22-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-306"><a href="#cb22-306" aria-hidden="true" tabindex="-1"></a><span class="fu">## Clean and Prepare Your Data</span></span>
<span id="cb22-307"><a href="#cb22-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-308"><a href="#cb22-308" aria-hidden="true" tabindex="-1"></a>Great! Now you know how to collect eye tracking data and save it with events. Let's add a few steps that will make your data much easier to work with and analyze.</span>
<span id="cb22-309"><a href="#cb22-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-310"><a href="#cb22-310" aria-hidden="true" tabindex="-1"></a><span class="fu">## Split Gaze Coordinates into Separate Columns</span></span>
<span id="cb22-311"><a href="#cb22-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-312"><a href="#cb22-312" aria-hidden="true" tabindex="-1"></a>When we save gaze data, coordinate pairs like <span class="in">`'left_gaze_point_on_display_area': (0.463, 0.487)`</span> become single columns containing tuples. This makes analysis difficult - you can't easily plot or calculate with x and y values when they're stuck together. We need separate columns for x and y coordinates for each eye.</span>
<span id="cb22-313"><a href="#cb22-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-314"><a href="#cb22-314" aria-hidden="true" tabindex="-1"></a>Let's update our save function:</span>
<span id="cb22-315"><a href="#cb22-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-318"><a href="#cb22-318" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-319"><a href="#cb22-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Save function</span></span>
<span id="cb22-320"><a href="#cb22-320" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_buffer_to_file(filename):</span>
<span id="cb22-321"><a href="#cb22-321" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer, Events</span>
<span id="cb22-322"><a href="#cb22-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-323"><a href="#cb22-323" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if there are data</span></span>
<span id="cb22-324"><a href="#cb22-324" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gaze_data_buffer:</span>
<span id="cb22-325"><a href="#cb22-325" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb22-326"><a href="#cb22-326" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-327"><a href="#cb22-327" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Swap buffers - get current data and start fresh</span></span>
<span id="cb22-328"><a href="#cb22-328" aria-hidden="true" tabindex="-1"></a>    saving_data, gaze_data_buffer <span class="op">=</span> gaze_data_buffer, []</span>
<span id="cb22-329"><a href="#cb22-329" aria-hidden="true" tabindex="-1"></a>    saving_events, Events <span class="op">=</span> Events, []</span>
<span id="cb22-330"><a href="#cb22-330" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-331"><a href="#cb22-331" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert lists to dataframes</span></span>
<span id="cb22-332"><a href="#cb22-332" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> pd.DataFrame(saving_data)</span>
<span id="cb22-333"><a href="#cb22-333" aria-hidden="true" tabindex="-1"></a>    events_df <span class="op">=</span> pd.DataFrame(saving_events)</span>
<span id="cb22-334"><a href="#cb22-334" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-335"><a href="#cb22-335" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match events with eye tracking data</span></span>
<span id="cb22-336"><a href="#cb22-336" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.searchsorted(data_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb22-337"><a href="#cb22-337" aria-hidden="true" tabindex="-1"></a>                          events_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb22-338"><a href="#cb22-338" aria-hidden="true" tabindex="-1"></a>                          side<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb22-339"><a href="#cb22-339" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'events'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb22-340"><a href="#cb22-340" aria-hidden="true" tabindex="-1"></a>    data_df.loc[idx, <span class="st">'events'</span>] <span class="op">=</span> events_df[<span class="st">'label'</span>].values</span>
<span id="cb22-341"><a href="#cb22-341" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-342"><a href="#cb22-342" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split coordinate tuples into separate columns</span></span>
<span id="cb22-343"><a href="#cb22-343" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'left_x'</span>, <span class="st">'left_y'</span>]] <span class="op">=</span> data_df[<span class="st">'left_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb22-344"><a href="#cb22-344" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'right_x'</span>, <span class="st">'right_y'</span>]] <span class="op">=</span> data_df[<span class="st">'right_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb22-345"><a href="#cb22-345" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-346"><a href="#cb22-346" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save to CSV</span></span>
<span id="cb22-347"><a href="#cb22-347" aria-hidden="true" tabindex="-1"></a>    data_df.to_csv(filename, mode<span class="op">=</span><span class="st">'a'</span>, index<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb22-348"><a href="#cb22-348" aria-hidden="true" tabindex="-1"></a>                   header<span class="op">=</span><span class="kw">not</span> os.path.isfile(filename))</span>
<span id="cb22-349"><a href="#cb22-349" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-350"><a href="#cb22-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-351"><a href="#cb22-351" aria-hidden="true" tabindex="-1"></a>Perfect! Now we have separate x and y columns for both eyes, making analysis much easier.</span>
<span id="cb22-352"><a href="#cb22-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-353"><a href="#cb22-353" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adjust the Data</span></span>
<span id="cb22-354"><a href="#cb22-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-355"><a href="#cb22-355" aria-hidden="true" tabindex="-1"></a>The Tobii eye tracker gives us coordinates from 0 to 1, where (0, 0) is the top-left corner of the screen and (1, 1) is the bottom-right corner.</span>
<span id="cb22-356"><a href="#cb22-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-357"><a href="#cb22-357" aria-hidden="true" tabindex="-1"></a>While this works fine, it can be confusing during analysis because most plotting systems expect the origin in the bottom-left corner, not the top-left. The image below shows this difference:</span>
<span id="cb22-358"><a href="#cb22-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-359"><a href="#cb22-359" aria-hidden="true" tabindex="-1"></a><span class="al">![](/images/CreateAnEyetrackingExperiment/Origins.png)</span>{fig-align="center" width="419"}</span>
<span id="cb22-360"><a href="#cb22-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-361"><a href="#cb22-361" aria-hidden="true" tabindex="-1"></a>Let's adjust our data to make it more analysis-friendly:</span>
<span id="cb22-362"><a href="#cb22-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-363"><a href="#cb22-363" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Flip the y-axis**: Move the origin to bottom-left by flipping y coordinates</span>
<span id="cb22-364"><a href="#cb22-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-365"><a href="#cb22-365" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Convert to pixels**: Change from 0-1 coordinates to actual pixel positions</span>
<span id="cb22-366"><a href="#cb22-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-367"><a href="#cb22-367" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Simplify timestamps**: Convert from microseconds to milliseconds</span>
<span id="cb22-368"><a href="#cb22-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-369"><a href="#cb22-369" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Clean up column names**: Make them shorter and more intuitive</span>
<span id="cb22-370"><a href="#cb22-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-371"><a href="#cb22-371" aria-hidden="true" tabindex="-1"></a>Here's our updated function:</span>
<span id="cb22-372"><a href="#cb22-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-375"><a href="#cb22-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-376"><a href="#cb22-376" aria-hidden="true" tabindex="-1"></a><span class="co"># Screen dimensions (replace with your actual screen size)</span></span>
<span id="cb22-377"><a href="#cb22-377" aria-hidden="true" tabindex="-1"></a>winsize <span class="op">=</span> [<span class="dv">1920</span>, <span class="dv">1080</span>]  <span class="co"># width, height in pixels</span></span>
<span id="cb22-378"><a href="#cb22-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-379"><a href="#cb22-379" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_buffer_to_file(filename):</span>
<span id="cb22-380"><a href="#cb22-380" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer, Events</span>
<span id="cb22-381"><a href="#cb22-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-382"><a href="#cb22-382" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if there are data</span></span>
<span id="cb22-383"><a href="#cb22-383" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gaze_data_buffer:</span>
<span id="cb22-384"><a href="#cb22-384" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb22-385"><a href="#cb22-385" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-386"><a href="#cb22-386" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Swap buffers - get current data and start fresh</span></span>
<span id="cb22-387"><a href="#cb22-387" aria-hidden="true" tabindex="-1"></a>    saving_data, gaze_data_buffer <span class="op">=</span> gaze_data_buffer, []</span>
<span id="cb22-388"><a href="#cb22-388" aria-hidden="true" tabindex="-1"></a>    saving_events, Events <span class="op">=</span> Events, []</span>
<span id="cb22-389"><a href="#cb22-389" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-390"><a href="#cb22-390" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert lists to dataframes</span></span>
<span id="cb22-391"><a href="#cb22-391" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> pd.DataFrame(saving_data)</span>
<span id="cb22-392"><a href="#cb22-392" aria-hidden="true" tabindex="-1"></a>    events_df <span class="op">=</span> pd.DataFrame(saving_events)</span>
<span id="cb22-393"><a href="#cb22-393" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-394"><a href="#cb22-394" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match events with eye tracking data</span></span>
<span id="cb22-395"><a href="#cb22-395" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.searchsorted(data_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb22-396"><a href="#cb22-396" aria-hidden="true" tabindex="-1"></a>                          events_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb22-397"><a href="#cb22-397" aria-hidden="true" tabindex="-1"></a>                          side<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb22-398"><a href="#cb22-398" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'events'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb22-399"><a href="#cb22-399" aria-hidden="true" tabindex="-1"></a>    data_df.loc[idx, <span class="st">'events'</span>] <span class="op">=</span> events_df[<span class="st">'label'</span>].values</span>
<span id="cb22-400"><a href="#cb22-400" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-401"><a href="#cb22-401" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split coordinate tuples into separate columns</span></span>
<span id="cb22-402"><a href="#cb22-402" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'left_x'</span>, <span class="st">'left_y'</span>]] <span class="op">=</span> data_df[<span class="st">'left_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb22-403"><a href="#cb22-403" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'right_x'</span>, <span class="st">'right_y'</span>]] <span class="op">=</span> data_df[<span class="st">'right_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb22-404"><a href="#cb22-404" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-405"><a href="#cb22-405" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert and adjust coordinates</span></span>
<span id="cb22-406"><a href="#cb22-406" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'time'</span>] <span class="op">=</span> data_df[<span class="st">'system_time_stamp'</span>] <span class="op">/</span> <span class="fl">1000.0</span></span>
<span id="cb22-407"><a href="#cb22-407" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'left_x'</span>] <span class="op">=</span> data_df[<span class="st">'left_x'</span>] <span class="op">*</span> winsize[<span class="dv">0</span>]</span>
<span id="cb22-408"><a href="#cb22-408" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'left_y'</span>] <span class="op">=</span> winsize[<span class="dv">1</span>] <span class="op">-</span> data_df[<span class="st">'left_y'</span>] <span class="op">*</span> winsize[<span class="dv">1</span>]  <span class="co"># Flip y-axis</span></span>
<span id="cb22-409"><a href="#cb22-409" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'right_x'</span>] <span class="op">=</span> data_df[<span class="st">'right_x'</span>] <span class="op">*</span> winsize[<span class="dv">0</span>]</span>
<span id="cb22-410"><a href="#cb22-410" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'right_y'</span>] <span class="op">=</span> winsize[<span class="dv">1</span>] <span class="op">-</span> data_df[<span class="st">'right_y'</span>] <span class="op">*</span> winsize[<span class="dv">1</span>]  <span class="co"># Flip y-axis</span></span>
<span id="cb22-411"><a href="#cb22-411" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-412"><a href="#cb22-412" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename columns for clarity</span></span>
<span id="cb22-413"><a href="#cb22-413" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> data_df.rename(columns<span class="op">=</span>{</span>
<span id="cb22-414"><a href="#cb22-414" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_gaze_point_validity'</span>: <span class="st">'left_valid'</span>,</span>
<span id="cb22-415"><a href="#cb22-415" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_gaze_point_validity'</span>: <span class="st">'right_valid'</span>,</span>
<span id="cb22-416"><a href="#cb22-416" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_pupil_diameter'</span>: <span class="st">'left_pupil'</span>,</span>
<span id="cb22-417"><a href="#cb22-417" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_pupil_diameter'</span>: <span class="st">'right_pupil'</span>,</span>
<span id="cb22-418"><a href="#cb22-418" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_pupil_validity'</span>: <span class="st">'left_pupil_valid'</span>,</span>
<span id="cb22-419"><a href="#cb22-419" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_pupil_validity'</span>: <span class="st">'right_pupil_valid'</span></span>
<span id="cb22-420"><a href="#cb22-420" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb22-421"><a href="#cb22-421" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-422"><a href="#cb22-422" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep only essential columns</span></span>
<span id="cb22-423"><a href="#cb22-423" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> data_df[[<span class="st">'time'</span>, <span class="st">'left_x'</span>, <span class="st">'left_y'</span>, <span class="st">'left_valid'</span>, <span class="st">'left_pupil'</span>, <span class="st">'left_pupil_valid'</span>,</span>
<span id="cb22-424"><a href="#cb22-424" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'right_x'</span>, <span class="st">'right_y'</span>, <span class="st">'right_valid'</span>, <span class="st">'right_pupil'</span>, <span class="st">'right_pupil_valid'</span>, <span class="st">'events'</span>]]</span>
<span id="cb22-425"><a href="#cb22-425" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-426"><a href="#cb22-426" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save to CSV</span></span>
<span id="cb22-427"><a href="#cb22-427" aria-hidden="true" tabindex="-1"></a>    data_df.to_csv(filename, mode<span class="op">=</span><span class="st">'a'</span>, index<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb22-428"><a href="#cb22-428" aria-hidden="true" tabindex="-1"></a>                   header<span class="op">=</span><span class="kw">not</span> os.path.isfile(filename))</span>
<span id="cb22-429"><a href="#cb22-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-430"><a href="#cb22-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-431"><a href="#cb22-431" aria-hidden="true" tabindex="-1"></a>Now our data is in pixel coordinates with the origin at the bottom-left, making it much easier to analyze and visualize!</span>
<span id="cb22-432"><a href="#cb22-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-433"><a href="#cb22-433" aria-hidden="true" tabindex="-1"></a><span class="fu"># Create the Actual Experiment</span></span>
<span id="cb22-434"><a href="#cb22-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-435"><a href="#cb22-435" aria-hidden="true" tabindex="-1"></a>Now we have two functions: one to collect eye tracking data and another to save it to CSV. Let's see how to use these in our actual study.</span>
<span id="cb22-436"><a href="#cb22-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-437"><a href="#cb22-437" aria-hidden="true" tabindex="-1"></a><span class="fu">## Short Recap of the Paradigm</span></span>
<span id="cb22-438"><a href="#cb22-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-439"><a href="#cb22-439" aria-hidden="true" tabindex="-1"></a>We'll use the experimental design from <span class="co">[</span><span class="ot">Getting started with PsychoPy</span><span class="co">](/CONTENT/GettingStarted/GettingStartedWithPsychopy.qmd)</span> and add eye tracking to it. If you need a refresher on the paradigm, take a quick look at that tutorial.</span>
<span id="cb22-440"><a href="#cb22-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-441"><a href="#cb22-441" aria-hidden="true" tabindex="-1"></a>Here's a brief summary: After a fixation cross, participants see either a circle or square. The circle predicts a complex shape that will appear on the right side of the screen, while the square predicts a simple shape will on the left.</span>
<span id="cb22-442"><a href="#cb22-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-443"><a href="#cb22-443" aria-hidden="true" tabindex="-1"></a><span class="fu">## Putting It All Together</span></span>
<span id="cb22-444"><a href="#cb22-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-445"><a href="#cb22-445" aria-hidden="true" tabindex="-1"></a>Let's build the complete experiment step by step.</span>
<span id="cb22-446"><a href="#cb22-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-447"><a href="#cb22-447" aria-hidden="true" tabindex="-1"></a><span class="fu">### Import Libraries and Define Functions</span></span>
<span id="cb22-448"><a href="#cb22-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-449"><a href="#cb22-449" aria-hidden="true" tabindex="-1"></a>First, let's import our libraries and define the functions we created earlier:</span>
<span id="cb22-450"><a href="#cb22-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-453"><a href="#cb22-453" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-454"><a href="#cb22-454" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb22-455"><a href="#cb22-455" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb22-456"><a href="#cb22-456" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb22-457"><a href="#cb22-457" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb22-458"><a href="#cb22-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-459"><a href="#cb22-459" aria-hidden="true" tabindex="-1"></a><span class="co"># Import PsychoPy libraries</span></span>
<span id="cb22-460"><a href="#cb22-460" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> psychopy <span class="im">import</span> core, event, visual, sound</span>
<span id="cb22-461"><a href="#cb22-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-462"><a href="#cb22-462" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tobii_research <span class="im">as</span> tr</span>
<span id="cb22-463"><a href="#cb22-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-464"><a href="#cb22-464" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Functions</span></span>
<span id="cb22-465"><a href="#cb22-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-466"><a href="#cb22-466" aria-hidden="true" tabindex="-1"></a><span class="co"># Screen dimensions</span></span>
<span id="cb22-467"><a href="#cb22-467" aria-hidden="true" tabindex="-1"></a>winsize <span class="op">=</span> [<span class="dv">1920</span>, <span class="dv">1080</span>]  <span class="co"># width, height in pixels</span></span>
<span id="cb22-468"><a href="#cb22-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-469"><a href="#cb22-469" aria-hidden="true" tabindex="-1"></a><span class="co"># This will be called every time there is new gaze data</span></span>
<span id="cb22-470"><a href="#cb22-470" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaze_data_callback(gaze_data):</span>
<span id="cb22-471"><a href="#cb22-471" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer</span>
<span id="cb22-472"><a href="#cb22-472" aria-hidden="true" tabindex="-1"></a>    gaze_data_buffer.append(gaze_data)</span>
<span id="cb22-473"><a href="#cb22-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-474"><a href="#cb22-474" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_buffer_to_file(filename):</span>
<span id="cb22-475"><a href="#cb22-475" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer, Events</span>
<span id="cb22-476"><a href="#cb22-476" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-477"><a href="#cb22-477" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gaze_data_buffer:</span>
<span id="cb22-478"><a href="#cb22-478" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb22-479"><a href="#cb22-479" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-480"><a href="#cb22-480" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Swap buffers - get current data and start fresh</span></span>
<span id="cb22-481"><a href="#cb22-481" aria-hidden="true" tabindex="-1"></a>    saving_data, gaze_data_buffer <span class="op">=</span> gaze_data_buffer, []</span>
<span id="cb22-482"><a href="#cb22-482" aria-hidden="true" tabindex="-1"></a>    saving_events, Events <span class="op">=</span> Events, []</span>
<span id="cb22-483"><a href="#cb22-483" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-484"><a href="#cb22-484" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert lists to dataframes</span></span>
<span id="cb22-485"><a href="#cb22-485" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> pd.DataFrame(saving_data)</span>
<span id="cb22-486"><a href="#cb22-486" aria-hidden="true" tabindex="-1"></a>    events_df <span class="op">=</span> pd.DataFrame(saving_events)</span>
<span id="cb22-487"><a href="#cb22-487" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-488"><a href="#cb22-488" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match events with eye tracking data</span></span>
<span id="cb22-489"><a href="#cb22-489" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.searchsorted(data_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb22-490"><a href="#cb22-490" aria-hidden="true" tabindex="-1"></a>                          events_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb22-491"><a href="#cb22-491" aria-hidden="true" tabindex="-1"></a>                          side<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb22-492"><a href="#cb22-492" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'events'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb22-493"><a href="#cb22-493" aria-hidden="true" tabindex="-1"></a>    data_df.loc[idx, <span class="st">'events'</span>] <span class="op">=</span> events_df[<span class="st">'label'</span>].values</span>
<span id="cb22-494"><a href="#cb22-494" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-495"><a href="#cb22-495" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split coordinate tuples into separate columns</span></span>
<span id="cb22-496"><a href="#cb22-496" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'left_x'</span>, <span class="st">'left_y'</span>]] <span class="op">=</span> data_df[<span class="st">'left_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb22-497"><a href="#cb22-497" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'right_x'</span>, <span class="st">'right_y'</span>]] <span class="op">=</span> data_df[<span class="st">'right_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb22-498"><a href="#cb22-498" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-499"><a href="#cb22-499" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert and adjust coordinates</span></span>
<span id="cb22-500"><a href="#cb22-500" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'time'</span>] <span class="op">=</span> data_df[<span class="st">'system_time_stamp'</span>] <span class="op">/</span> <span class="fl">1000.0</span></span>
<span id="cb22-501"><a href="#cb22-501" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'left_x'</span>] <span class="op">=</span> data_df[<span class="st">'left_x'</span>] <span class="op">*</span> winsize[<span class="dv">0</span>]</span>
<span id="cb22-502"><a href="#cb22-502" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'left_y'</span>] <span class="op">=</span> winsize[<span class="dv">1</span>] <span class="op">-</span> data_df[<span class="st">'left_y'</span>] <span class="op">*</span> winsize[<span class="dv">1</span>]  <span class="co"># Flip y-axis</span></span>
<span id="cb22-503"><a href="#cb22-503" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'right_x'</span>] <span class="op">=</span> data_df[<span class="st">'right_x'</span>] <span class="op">*</span> winsize[<span class="dv">0</span>]</span>
<span id="cb22-504"><a href="#cb22-504" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'right_y'</span>] <span class="op">=</span> winsize[<span class="dv">1</span>] <span class="op">-</span> data_df[<span class="st">'right_y'</span>] <span class="op">*</span> winsize[<span class="dv">1</span>]  <span class="co"># Flip y-axis</span></span>
<span id="cb22-505"><a href="#cb22-505" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-506"><a href="#cb22-506" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename columns for clarity</span></span>
<span id="cb22-507"><a href="#cb22-507" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> data_df.rename(columns<span class="op">=</span>{</span>
<span id="cb22-508"><a href="#cb22-508" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_gaze_point_validity'</span>: <span class="st">'left_valid'</span>,</span>
<span id="cb22-509"><a href="#cb22-509" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_gaze_point_validity'</span>: <span class="st">'right_valid'</span>,</span>
<span id="cb22-510"><a href="#cb22-510" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_pupil_diameter'</span>: <span class="st">'left_pupil'</span>,</span>
<span id="cb22-511"><a href="#cb22-511" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_pupil_diameter'</span>: <span class="st">'right_pupil'</span>,</span>
<span id="cb22-512"><a href="#cb22-512" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_pupil_validity'</span>: <span class="st">'left_pupil_valid'</span>,</span>
<span id="cb22-513"><a href="#cb22-513" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_pupil_validity'</span>: <span class="st">'right_pupil_valid'</span></span>
<span id="cb22-514"><a href="#cb22-514" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb22-515"><a href="#cb22-515" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-516"><a href="#cb22-516" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep only essential columns</span></span>
<span id="cb22-517"><a href="#cb22-517" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> data_df[[<span class="st">'time'</span>, <span class="st">'left_x'</span>, <span class="st">'left_y'</span>, <span class="st">'left_valid'</span>, <span class="st">'left_pupil'</span>, <span class="st">'left_pupil_valid'</span>,</span>
<span id="cb22-518"><a href="#cb22-518" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'right_x'</span>, <span class="st">'right_y'</span>, <span class="st">'right_valid'</span>, <span class="st">'right_pupil'</span>, <span class="st">'right_pupil_valid'</span>, <span class="st">'events'</span>]]</span>
<span id="cb22-519"><a href="#cb22-519" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-520"><a href="#cb22-520" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save to CSV</span></span>
<span id="cb22-521"><a href="#cb22-521" aria-hidden="true" tabindex="-1"></a>    data_df.to_csv(filename, mode<span class="op">=</span><span class="st">'a'</span>, index<span class="op">=</span><span class="va">False</span>, header<span class="op">=</span><span class="kw">not</span> os.path.isfile(filename))</span>
<span id="cb22-522"><a href="#cb22-522" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-523"><a href="#cb22-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-524"><a href="#cb22-524" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load the Stimuli</span></span>
<span id="cb22-525"><a href="#cb22-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-526"><a href="#cb22-526" aria-hidden="true" tabindex="-1"></a>Now let's set up our experiment window and load all the stimuli. This part is identical to our previous PsychoPy tutorial:</span>
<span id="cb22-527"><a href="#cb22-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-530"><a href="#cb22-530" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-531"><a href="#cb22-531" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Load and prepare stimuli</span></span>
<span id="cb22-532"><a href="#cb22-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-533"><a href="#cb22-533" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting the directory of our experiment</span></span>
<span id="cb22-534"><a href="#cb22-534" aria-hidden="true" tabindex="-1"></a>os.chdir(<span class="vs">r'&lt;&lt;&lt; YOUR PATH &gt;&gt;&gt;&gt;'</span>)</span>
<span id="cb22-535"><a href="#cb22-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-536"><a href="#cb22-536" aria-hidden="true" tabindex="-1"></a><span class="co"># Now create a Path object for the stimuli directory</span></span>
<span id="cb22-537"><a href="#cb22-537" aria-hidden="true" tabindex="-1"></a>stimuli_dir <span class="op">=</span> Path(<span class="st">'EXP'</span>) <span class="op">/</span> <span class="st">'Stimuli'</span></span>
<span id="cb22-538"><a href="#cb22-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-539"><a href="#cb22-539" aria-hidden="true" tabindex="-1"></a><span class="co"># Load images </span></span>
<span id="cb22-540"><a href="#cb22-540" aria-hidden="true" tabindex="-1"></a>fixation <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'fixation.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb22-541"><a href="#cb22-541" aria-hidden="true" tabindex="-1"></a>circle <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'circle.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb22-542"><a href="#cb22-542" aria-hidden="true" tabindex="-1"></a>square <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'square.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb22-543"><a href="#cb22-543" aria-hidden="true" tabindex="-1"></a><span class="bu">complex</span> <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'complex.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>), pos<span class="op">=</span>(<span class="dv">250</span>, <span class="dv">0</span>))</span>
<span id="cb22-544"><a href="#cb22-544" aria-hidden="true" tabindex="-1"></a>simple <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'simple.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>), pos<span class="op">=</span>(<span class="op">-</span><span class="dv">250</span>, <span class="dv">0</span>))</span>
<span id="cb22-545"><a href="#cb22-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-546"><a href="#cb22-546" aria-hidden="true" tabindex="-1"></a><span class="co"># Load sound </span></span>
<span id="cb22-547"><a href="#cb22-547" aria-hidden="true" tabindex="-1"></a>presentation_sound <span class="op">=</span> sound.Sound(<span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'presentation.wav'</span>))</span>
<span id="cb22-548"><a href="#cb22-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-549"><a href="#cb22-549" aria-hidden="true" tabindex="-1"></a><span class="co"># List of stimuli</span></span>
<span id="cb22-550"><a href="#cb22-550" aria-hidden="true" tabindex="-1"></a>cues <span class="op">=</span> [circle, square] <span class="co"># put both cues in a list</span></span>
<span id="cb22-551"><a href="#cb22-551" aria-hidden="true" tabindex="-1"></a>targets <span class="op">=</span> [<span class="bu">complex</span>, simple] <span class="co"># put both rewards in a list</span></span>
<span id="cb22-552"><a href="#cb22-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-553"><a href="#cb22-553" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of trials in which 0 means winning and 1 means losing</span></span>
<span id="cb22-554"><a href="#cb22-554" aria-hidden="true" tabindex="-1"></a>Trials <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span> ]</span>
<span id="cb22-555"><a href="#cb22-555" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-556"><a href="#cb22-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-557"><a href="#cb22-557" aria-hidden="true" tabindex="-1"></a><span class="fu">### Start recording</span></span>
<span id="cb22-558"><a href="#cb22-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-559"><a href="#cb22-559" aria-hidden="true" tabindex="-1"></a>Now we're ready to find eye trackers connected to the computer and start collecting data. We'll use the first eye tracker we find and launch our callback function to begin data collection.</span>
<span id="cb22-560"><a href="#cb22-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-563"><a href="#cb22-563" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-564"><a href="#cb22-564" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Record the data</span></span>
<span id="cb22-565"><a href="#cb22-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-566"><a href="#cb22-566" aria-hidden="true" tabindex="-1"></a><span class="co"># Find all connected eye trackers</span></span>
<span id="cb22-567"><a href="#cb22-567" aria-hidden="true" tabindex="-1"></a>found_eyetrackers <span class="op">=</span> tr.find_all_eyetrackers()</span>
<span id="cb22-568"><a href="#cb22-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-569"><a href="#cb22-569" aria-hidden="true" tabindex="-1"></a><span class="co"># We will just use the first one</span></span>
<span id="cb22-570"><a href="#cb22-570" aria-hidden="true" tabindex="-1"></a>Eyetracker <span class="op">=</span> found_eyetrackers[<span class="dv">0</span>]</span>
<span id="cb22-571"><a href="#cb22-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-572"><a href="#cb22-572" aria-hidden="true" tabindex="-1"></a><span class="co"># Create our data buffers</span></span>
<span id="cb22-573"><a href="#cb22-573" aria-hidden="true" tabindex="-1"></a>gaze_data_buffer <span class="op">=</span> []</span>
<span id="cb22-574"><a href="#cb22-574" aria-hidden="true" tabindex="-1"></a>Events <span class="op">=</span> []</span>
<span id="cb22-575"><a href="#cb22-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-576"><a href="#cb22-576" aria-hidden="true" tabindex="-1"></a><span class="co"># Start recording</span></span>
<span id="cb22-577"><a href="#cb22-577" aria-hidden="true" tabindex="-1"></a>Eyetracker.subscribe_to(tr.EYETRACKER_GAZE_DATA, gaze_data_callback)</span>
<span id="cb22-578"><a href="#cb22-578" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-579"><a href="#cb22-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-580"><a href="#cb22-580" aria-hidden="true" tabindex="-1"></a><span class="fu">### Present Our Stimuli</span></span>
<span id="cb22-581"><a href="#cb22-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-582"><a href="#cb22-582" aria-hidden="true" tabindex="-1"></a>The eye tracking is running! Let's show our participant something!</span>
<span id="cb22-583"><a href="#cb22-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-584"><a href="#cb22-584" aria-hidden="true" tabindex="-1"></a>Notice that after each time we flip our window (which actually displays what we drew), we add an event to our Events list with a timestamp and label. This marks exactly when each stimulus appeared.</span>
<span id="cb22-585"><a href="#cb22-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-588"><a href="#cb22-588" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-589"><a href="#cb22-589" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Trials</span></span>
<span id="cb22-590"><a href="#cb22-590" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trial <span class="kw">in</span> Trials:</span>
<span id="cb22-591"><a href="#cb22-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-592"><a href="#cb22-592" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Present the fixation</span></span>
<span id="cb22-593"><a href="#cb22-593" aria-hidden="true" tabindex="-1"></a>    win.flip()  <span class="co"># Clear the window</span></span>
<span id="cb22-594"><a href="#cb22-594" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-595"><a href="#cb22-595" aria-hidden="true" tabindex="-1"></a>    fixation.draw()</span>
<span id="cb22-596"><a href="#cb22-596" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb22-597"><a href="#cb22-597" aria-hidden="true" tabindex="-1"></a>    Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Fixation'</span>})</span>
<span id="cb22-598"><a href="#cb22-598" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">1</span>)  <span class="co"># Wait for 1 second</span></span>
<span id="cb22-599"><a href="#cb22-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-600"><a href="#cb22-600" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Present the cue</span></span>
<span id="cb22-601"><a href="#cb22-601" aria-hidden="true" tabindex="-1"></a>    cues[trial].draw()</span>
<span id="cb22-602"><a href="#cb22-602" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb22-603"><a href="#cb22-603" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> trial <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-604"><a href="#cb22-604" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Circle'</span>})</span>
<span id="cb22-605"><a href="#cb22-605" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb22-606"><a href="#cb22-606" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Square'</span>})</span>
<span id="cb22-607"><a href="#cb22-607" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">3</span>)  <span class="co"># Wait for 3 seconds</span></span>
<span id="cb22-608"><a href="#cb22-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-609"><a href="#cb22-609" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Wait for saccadic latency</span></span>
<span id="cb22-610"><a href="#cb22-610" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb22-611"><a href="#cb22-611" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="fl">0.75</span>)</span>
<span id="cb22-612"><a href="#cb22-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-613"><a href="#cb22-613" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Present the target</span></span>
<span id="cb22-614"><a href="#cb22-614" aria-hidden="true" tabindex="-1"></a>    targets[trial].draw()</span>
<span id="cb22-615"><a href="#cb22-615" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb22-616"><a href="#cb22-616" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> trial <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-617"><a href="#cb22-617" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Complex'</span>})</span>
<span id="cb22-618"><a href="#cb22-618" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb22-619"><a href="#cb22-619" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Simple'</span>})</span>
<span id="cb22-620"><a href="#cb22-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-621"><a href="#cb22-621" aria-hidden="true" tabindex="-1"></a>    presentation_sound.play()</span>
<span id="cb22-622"><a href="#cb22-622" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">2</span>)  <span class="co"># Wait for 2 seconds</span></span>
<span id="cb22-623"><a href="#cb22-623" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-624"><a href="#cb22-624" aria-hidden="true" tabindex="-1"></a>    <span class="co">### ISI and save data</span></span>
<span id="cb22-625"><a href="#cb22-625" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb22-626"><a href="#cb22-626" aria-hidden="true" tabindex="-1"></a>    clock <span class="op">=</span> core.Clock()  <span class="co"># start the clock</span></span>
<span id="cb22-627"><a href="#cb22-627" aria-hidden="true" tabindex="-1"></a>    write_buffer_to_file(gaze_data_buffer, Path(<span class="st">'DATA'</span>) <span class="op">/</span> <span class="st">'RAW'</span> <span class="op">/</span> (Sub <span class="op">+</span> <span class="st">'.csv'</span>))</span>
<span id="cb22-628"><a href="#cb22-628" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">1</span> <span class="op">-</span> clock.getTime()) <span class="co"># wait for remaining time</span></span>
<span id="cb22-629"><a href="#cb22-629" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-630"><a href="#cb22-630" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Check for escape key to exit</span></span>
<span id="cb22-631"><a href="#cb22-631" aria-hidden="true" tabindex="-1"></a>    keys <span class="op">=</span> event.getKeys()</span>
<span id="cb22-632"><a href="#cb22-632" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'escape'</span> <span class="kw">in</span> keys:</span>
<span id="cb22-633"><a href="#cb22-633" aria-hidden="true" tabindex="-1"></a>        win.close()</span>
<span id="cb22-634"><a href="#cb22-634" aria-hidden="true" tabindex="-1"></a>        Eyetracker.unsubscribe_from(tr.EYETRACKER_GAZE_DATA, gaze_data_callback)</span>
<span id="cb22-635"><a href="#cb22-635" aria-hidden="true" tabindex="-1"></a>        core.quit()</span>
<span id="cb22-636"><a href="#cb22-636" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-637"><a href="#cb22-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-638"><a href="#cb22-638" aria-hidden="true" tabindex="-1"></a>As we said before in <span class="sc">\[</span>Save the data<span class="sc">\]</span>, it's best to save data during our study to avoid potential data loss. It's better to do this when there are things of minor interest, such as during the ISI. If you remember from the previous tutorial <span class="co">[</span><span class="ot">Getting started with Psychopy</span><span class="co">](/CONTENT/GettingStarted/GettingStartedWithPsychopy.qmd)</span>, we created the ISI in a different way than just using <span class="in">`core.wait()`</span>, and we said that this different method would come in handy later on. This is the moment!</span>
<span id="cb22-639"><a href="#cb22-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-640"><a href="#cb22-640" aria-hidden="true" tabindex="-1"></a>Our ISI starts the clock and saves the data immediately. After saving, we calculate how much time remains to reach the full 1-second duration and use core.wait() for any remaining time. This ensures we wait for exactly 1 second total, accounting for the time spent saving data.</span>
<span id="cb22-641"><a href="#cb22-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-644"><a href="#cb22-644" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-645"><a href="#cb22-645" aria-hidden="true" tabindex="-1"></a><span class="co">### ISI and save data</span></span>
<span id="cb22-646"><a href="#cb22-646" aria-hidden="true" tabindex="-1"></a>win.flip()</span>
<span id="cb22-647"><a href="#cb22-647" aria-hidden="true" tabindex="-1"></a>clock <span class="op">=</span> core.Clock()  <span class="co"># start the clock</span></span>
<span id="cb22-648"><a href="#cb22-648" aria-hidden="true" tabindex="-1"></a>write_buffer_to_file(gaze_data_buffer, Path(<span class="st">'DATA'</span>) <span class="op">/</span> <span class="st">'RAW'</span> <span class="op">/</span> (Sub <span class="op">+</span> <span class="st">'.csv'</span>))</span>
<span id="cb22-649"><a href="#cb22-649" aria-hidden="true" tabindex="-1"></a>core.wait(<span class="dv">1</span> <span class="op">-</span> clock.getTime()) <span class="co"># wait for remaining time</span></span>
<span id="cb22-650"><a href="#cb22-650" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-651"><a href="#cb22-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-652"><a href="#cb22-652" aria-hidden="true" tabindex="-1"></a>::: callout-warning</span>
<span id="cb22-653"><a href="#cb22-653" aria-hidden="true" tabindex="-1"></a>Careful!!!\</span>
<span id="cb22-654"><a href="#cb22-654" aria-hidden="true" tabindex="-1"></a>If saving the data takes more than 1 second, your&nbsp;ISI&nbsp;will also be longer. However, this should not be the case with typical studies where trials are not too long. Nonetheless, it's always a good idea to keep an eye out.</span>
<span id="cb22-655"><a href="#cb22-655" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb22-656"><a href="#cb22-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-657"><a href="#cb22-657" aria-hidden="true" tabindex="-1"></a><span class="fu">### Stop recording</span></span>
<span id="cb22-658"><a href="#cb22-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-659"><a href="#cb22-659" aria-hidden="true" tabindex="-1"></a>Almost done! We've collected data, sent events, and saved everything. The final step is to stop data collection (otherwise Python will keep getting endless data from the eye tracker!). We simply unsubscribe from the eye tracker:</span>
<span id="cb22-660"><a href="#cb22-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-663"><a href="#cb22-663" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-664"><a href="#cb22-664" aria-hidden="true" tabindex="-1"></a><span class="co"># Final save to catch any remaining data</span></span>
<span id="cb22-665"><a href="#cb22-665" aria-hidden="true" tabindex="-1"></a>write_buffer_to_file(Path(<span class="st">'DATA'</span>) <span class="op">/</span> <span class="st">'RAW'</span> <span class="op">/</span> (Sub <span class="op">+</span> <span class="st">'.csv'</span>))</span>
<span id="cb22-666"><a href="#cb22-666" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb22-667"><a href="#cb22-667" aria-hidden="true" tabindex="-1"></a>win.close()  <span class="co"># Close the window</span></span>
<span id="cb22-668"><a href="#cb22-668" aria-hidden="true" tabindex="-1"></a>Eyetracker.unsubscribe_from(tr.EYETRACKER_GAZE_DATA, gaze_data_callback)  <span class="co"># Stop eye tracking</span></span>
<span id="cb22-669"><a href="#cb22-669" aria-hidden="true" tabindex="-1"></a>core.quit()  <span class="co"># End the study</span></span>
<span id="cb22-670"><a href="#cb22-670" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-671"><a href="#cb22-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-672"><a href="#cb22-672" aria-hidden="true" tabindex="-1"></a>Note that we also closed the Psychopy window, so that the stimulus presentation is also officially over. Well done!!! Now go and get your data!!! We'll see you back when it's time to analyze it.</span>
<span id="cb22-673"><a href="#cb22-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-674"><a href="#cb22-674" aria-hidden="true" tabindex="-1"></a><span class="fu"># END!!</span></span>
<span id="cb22-675"><a href="#cb22-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-676"><a href="#cb22-676" aria-hidden="true" tabindex="-1"></a>Great job getting to here!! it want easy but you did it. Here is all the code we made together.</span>
<span id="cb22-677"><a href="#cb22-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-680"><a href="#cb22-680" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb22-681"><a href="#cb22-681" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb22-682"><a href="#cb22-682" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb22-683"><a href="#cb22-683" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb22-684"><a href="#cb22-684" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb22-685"><a href="#cb22-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-686"><a href="#cb22-686" aria-hidden="true" tabindex="-1"></a><span class="co"># Import PsychoPy libraries</span></span>
<span id="cb22-687"><a href="#cb22-687" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> psychopy <span class="im">import</span> core, event, visual, sound</span>
<span id="cb22-688"><a href="#cb22-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-689"><a href="#cb22-689" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tobii_research <span class="im">as</span> tr</span>
<span id="cb22-690"><a href="#cb22-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-691"><a href="#cb22-691" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Functions</span></span>
<span id="cb22-692"><a href="#cb22-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-693"><a href="#cb22-693" aria-hidden="true" tabindex="-1"></a><span class="co"># Screen dimensions</span></span>
<span id="cb22-694"><a href="#cb22-694" aria-hidden="true" tabindex="-1"></a>winsize <span class="op">=</span> [<span class="dv">1920</span>, <span class="dv">1080</span>]  <span class="co"># width, height in pixels</span></span>
<span id="cb22-695"><a href="#cb22-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-696"><a href="#cb22-696" aria-hidden="true" tabindex="-1"></a><span class="co"># This will be called every time there is new gaze data</span></span>
<span id="cb22-697"><a href="#cb22-697" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaze_data_callback(gaze_data):</span>
<span id="cb22-698"><a href="#cb22-698" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer</span>
<span id="cb22-699"><a href="#cb22-699" aria-hidden="true" tabindex="-1"></a>    gaze_data_buffer.append(gaze_data)</span>
<span id="cb22-700"><a href="#cb22-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-701"><a href="#cb22-701" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_buffer_to_file(filename):</span>
<span id="cb22-702"><a href="#cb22-702" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> gaze_data_buffer, Events</span>
<span id="cb22-703"><a href="#cb22-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-704"><a href="#cb22-704" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if there are data</span></span>
<span id="cb22-705"><a href="#cb22-705" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gaze_data_buffer:</span>
<span id="cb22-706"><a href="#cb22-706" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb22-707"><a href="#cb22-707" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-708"><a href="#cb22-708" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Swap buffers - get current data and start fresh</span></span>
<span id="cb22-709"><a href="#cb22-709" aria-hidden="true" tabindex="-1"></a>    saving_data, gaze_data_buffer <span class="op">=</span> gaze_data_buffer, []</span>
<span id="cb22-710"><a href="#cb22-710" aria-hidden="true" tabindex="-1"></a>    saving_events, Events <span class="op">=</span> Events, []</span>
<span id="cb22-711"><a href="#cb22-711" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-712"><a href="#cb22-712" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert lists to dataframes</span></span>
<span id="cb22-713"><a href="#cb22-713" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> pd.DataFrame(saving_data)</span>
<span id="cb22-714"><a href="#cb22-714" aria-hidden="true" tabindex="-1"></a>    events_df <span class="op">=</span> pd.DataFrame(saving_events)</span>
<span id="cb22-715"><a href="#cb22-715" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-716"><a href="#cb22-716" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match events with eye tracking data</span></span>
<span id="cb22-717"><a href="#cb22-717" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.searchsorted(data_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb22-718"><a href="#cb22-718" aria-hidden="true" tabindex="-1"></a>                          events_df[<span class="st">'system_time_stamp'</span>].values,</span>
<span id="cb22-719"><a href="#cb22-719" aria-hidden="true" tabindex="-1"></a>                          side<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb22-720"><a href="#cb22-720" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'events'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb22-721"><a href="#cb22-721" aria-hidden="true" tabindex="-1"></a>    data_df.loc[idx, <span class="st">'events'</span>] <span class="op">=</span> events_df[<span class="st">'label'</span>].values</span>
<span id="cb22-722"><a href="#cb22-722" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-723"><a href="#cb22-723" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split coordinate tuples into separate columns</span></span>
<span id="cb22-724"><a href="#cb22-724" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'left_x'</span>, <span class="st">'left_y'</span>]] <span class="op">=</span> data_df[<span class="st">'left_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb22-725"><a href="#cb22-725" aria-hidden="true" tabindex="-1"></a>    data_df[[<span class="st">'right_x'</span>, <span class="st">'right_y'</span>]] <span class="op">=</span> data_df[<span class="st">'right_gaze_point_on_display_area'</span>].tolist()</span>
<span id="cb22-726"><a href="#cb22-726" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-727"><a href="#cb22-727" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert and adjust coordinates</span></span>
<span id="cb22-728"><a href="#cb22-728" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'time'</span>] <span class="op">=</span> data_df[<span class="st">'system_time_stamp'</span>] <span class="op">/</span> <span class="fl">1000.0</span></span>
<span id="cb22-729"><a href="#cb22-729" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'left_x'</span>] <span class="op">=</span> data_df[<span class="st">'left_x'</span>] <span class="op">*</span> winsize[<span class="dv">0</span>]</span>
<span id="cb22-730"><a href="#cb22-730" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'left_y'</span>] <span class="op">=</span> winsize[<span class="dv">1</span>] <span class="op">-</span> data_df[<span class="st">'left_y'</span>] <span class="op">*</span> winsize[<span class="dv">1</span>]  <span class="co"># Flip y-axis</span></span>
<span id="cb22-731"><a href="#cb22-731" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'right_x'</span>] <span class="op">=</span> data_df[<span class="st">'right_x'</span>] <span class="op">*</span> winsize[<span class="dv">0</span>]</span>
<span id="cb22-732"><a href="#cb22-732" aria-hidden="true" tabindex="-1"></a>    data_df[<span class="st">'right_y'</span>] <span class="op">=</span> winsize[<span class="dv">1</span>] <span class="op">-</span> data_df[<span class="st">'right_y'</span>] <span class="op">*</span> winsize[<span class="dv">1</span>]  <span class="co"># Flip y-axis</span></span>
<span id="cb22-733"><a href="#cb22-733" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-734"><a href="#cb22-734" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename columns for clarity</span></span>
<span id="cb22-735"><a href="#cb22-735" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> data_df.rename(columns<span class="op">=</span>{</span>
<span id="cb22-736"><a href="#cb22-736" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_gaze_point_validity'</span>: <span class="st">'left_valid'</span>,</span>
<span id="cb22-737"><a href="#cb22-737" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_gaze_point_validity'</span>: <span class="st">'right_valid'</span>,</span>
<span id="cb22-738"><a href="#cb22-738" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_pupil_diameter'</span>: <span class="st">'left_pupil'</span>,</span>
<span id="cb22-739"><a href="#cb22-739" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_pupil_diameter'</span>: <span class="st">'right_pupil'</span>,</span>
<span id="cb22-740"><a href="#cb22-740" aria-hidden="true" tabindex="-1"></a>        <span class="st">'left_pupil_validity'</span>: <span class="st">'left_pupil_valid'</span>,</span>
<span id="cb22-741"><a href="#cb22-741" aria-hidden="true" tabindex="-1"></a>        <span class="st">'right_pupil_validity'</span>: <span class="st">'right_pupil_valid'</span></span>
<span id="cb22-742"><a href="#cb22-742" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb22-743"><a href="#cb22-743" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-744"><a href="#cb22-744" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep only essential columns</span></span>
<span id="cb22-745"><a href="#cb22-745" aria-hidden="true" tabindex="-1"></a>    data_df <span class="op">=</span> data_df[[<span class="st">'time'</span>, <span class="st">'left_x'</span>, <span class="st">'left_y'</span>, <span class="st">'left_valid'</span>, <span class="st">'left_pupil'</span>, <span class="st">'left_pupil_valid'</span>,</span>
<span id="cb22-746"><a href="#cb22-746" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'right_x'</span>, <span class="st">'right_y'</span>, <span class="st">'right_valid'</span>, <span class="st">'right_pupil'</span>, <span class="st">'right_pupil_valid'</span>, <span class="st">'events'</span>]]</span>
<span id="cb22-747"><a href="#cb22-747" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-748"><a href="#cb22-748" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save to CSV</span></span>
<span id="cb22-749"><a href="#cb22-749" aria-hidden="true" tabindex="-1"></a>    data_df.to_csv(filename, mode<span class="op">=</span><span class="st">'a'</span>, index<span class="op">=</span><span class="va">False</span>, header<span class="op">=</span><span class="kw">not</span> os.path.isfile(filename))</span>
<span id="cb22-750"><a href="#cb22-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-751"><a href="#cb22-751" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Load and prepare stimuli</span></span>
<span id="cb22-752"><a href="#cb22-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-753"><a href="#cb22-753" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting the directory of our experiment</span></span>
<span id="cb22-754"><a href="#cb22-754" aria-hidden="true" tabindex="-1"></a>os.chdir(<span class="vs">r'&lt;&lt;&lt; YOUR PATH &gt;&gt;&gt;&gt;'</span>)</span>
<span id="cb22-755"><a href="#cb22-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-756"><a href="#cb22-756" aria-hidden="true" tabindex="-1"></a><span class="co"># Now create a Path object for the stimuli directory</span></span>
<span id="cb22-757"><a href="#cb22-757" aria-hidden="true" tabindex="-1"></a>stimuli_dir <span class="op">=</span> Path(<span class="st">'EXP'</span>) <span class="op">/</span> <span class="st">'Stimuli'</span></span>
<span id="cb22-758"><a href="#cb22-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-759"><a href="#cb22-759" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a window</span></span>
<span id="cb22-760"><a href="#cb22-760" aria-hidden="true" tabindex="-1"></a>win <span class="op">=</span> visual.Window(size<span class="op">=</span>winsize, fullscr<span class="op">=</span><span class="va">True</span>, units<span class="op">=</span><span class="st">"pix"</span>, pos<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">30</span>), screen<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb22-761"><a href="#cb22-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-762"><a href="#cb22-762" aria-hidden="true" tabindex="-1"></a><span class="co"># Load images </span></span>
<span id="cb22-763"><a href="#cb22-763" aria-hidden="true" tabindex="-1"></a>fixation <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'fixation.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb22-764"><a href="#cb22-764" aria-hidden="true" tabindex="-1"></a>circle <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'circle.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb22-765"><a href="#cb22-765" aria-hidden="true" tabindex="-1"></a>square <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'square.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb22-766"><a href="#cb22-766" aria-hidden="true" tabindex="-1"></a><span class="bu">complex</span> <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'complex.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>), pos<span class="op">=</span>(<span class="dv">250</span>, <span class="dv">0</span>))</span>
<span id="cb22-767"><a href="#cb22-767" aria-hidden="true" tabindex="-1"></a>simple <span class="op">=</span> visual.ImageStim(win, image<span class="op">=</span><span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'simple.png'</span>), size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>), pos<span class="op">=</span>(<span class="op">-</span><span class="dv">250</span>, <span class="dv">0</span>))</span>
<span id="cb22-768"><a href="#cb22-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-769"><a href="#cb22-769" aria-hidden="true" tabindex="-1"></a><span class="co"># Load sound </span></span>
<span id="cb22-770"><a href="#cb22-770" aria-hidden="true" tabindex="-1"></a>presentation_sound <span class="op">=</span> sound.Sound(<span class="bu">str</span>(stimuli_dir <span class="op">/</span> <span class="st">'presentation.wav'</span>))</span>
<span id="cb22-771"><a href="#cb22-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-772"><a href="#cb22-772" aria-hidden="true" tabindex="-1"></a><span class="co"># List of stimuli</span></span>
<span id="cb22-773"><a href="#cb22-773" aria-hidden="true" tabindex="-1"></a>cues <span class="op">=</span> [circle, square] <span class="co"># put both cues in a list</span></span>
<span id="cb22-774"><a href="#cb22-774" aria-hidden="true" tabindex="-1"></a>targets <span class="op">=</span> [<span class="bu">complex</span>, simple] <span class="co"># put both rewards in a list</span></span>
<span id="cb22-775"><a href="#cb22-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-776"><a href="#cb22-776" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of trials in which 0 means winning and 1 means losing</span></span>
<span id="cb22-777"><a href="#cb22-777" aria-hidden="true" tabindex="-1"></a>Trials <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb22-778"><a href="#cb22-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-779"><a href="#cb22-779" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Record the data</span></span>
<span id="cb22-780"><a href="#cb22-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-781"><a href="#cb22-781" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the subject name</span></span>
<span id="cb22-782"><a href="#cb22-782" aria-hidden="true" tabindex="-1"></a>Sub <span class="op">=</span> <span class="st">'S001'</span></span>
<span id="cb22-783"><a href="#cb22-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-784"><a href="#cb22-784" aria-hidden="true" tabindex="-1"></a><span class="co"># Find all connected eye trackers</span></span>
<span id="cb22-785"><a href="#cb22-785" aria-hidden="true" tabindex="-1"></a>found_eyetrackers <span class="op">=</span> tr.find_all_eyetrackers()</span>
<span id="cb22-786"><a href="#cb22-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-787"><a href="#cb22-787" aria-hidden="true" tabindex="-1"></a><span class="co"># We will just use the first one</span></span>
<span id="cb22-788"><a href="#cb22-788" aria-hidden="true" tabindex="-1"></a>Eyetracker <span class="op">=</span> found_eyetrackers[<span class="dv">0</span>]</span>
<span id="cb22-789"><a href="#cb22-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-790"><a href="#cb22-790" aria-hidden="true" tabindex="-1"></a><span class="co"># Create our data buffers</span></span>
<span id="cb22-791"><a href="#cb22-791" aria-hidden="true" tabindex="-1"></a>gaze_data_buffer <span class="op">=</span> []</span>
<span id="cb22-792"><a href="#cb22-792" aria-hidden="true" tabindex="-1"></a>Events <span class="op">=</span> []</span>
<span id="cb22-793"><a href="#cb22-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-794"><a href="#cb22-794" aria-hidden="true" tabindex="-1"></a><span class="co"># Start recording</span></span>
<span id="cb22-795"><a href="#cb22-795" aria-hidden="true" tabindex="-1"></a>Eyetracker.subscribe_to(tr.EYETRACKER_GAZE_DATA, gaze_data_callback)</span>
<span id="cb22-796"><a href="#cb22-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-797"><a href="#cb22-797" aria-hidden="true" tabindex="-1"></a><span class="co">#%% Trials</span></span>
<span id="cb22-798"><a href="#cb22-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-799"><a href="#cb22-799" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trial <span class="kw">in</span> Trials:</span>
<span id="cb22-800"><a href="#cb22-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-801"><a href="#cb22-801" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Present the fixation</span></span>
<span id="cb22-802"><a href="#cb22-802" aria-hidden="true" tabindex="-1"></a>    win.flip() <span class="co"># we flip to clean the window</span></span>
<span id="cb22-803"><a href="#cb22-803" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-804"><a href="#cb22-804" aria-hidden="true" tabindex="-1"></a>    fixation.draw()</span>
<span id="cb22-805"><a href="#cb22-805" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb22-806"><a href="#cb22-806" aria-hidden="true" tabindex="-1"></a>    Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Fixation'</span>})</span>
<span id="cb22-807"><a href="#cb22-807" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">1</span>)  <span class="co"># wait for 1 second</span></span>
<span id="cb22-808"><a href="#cb22-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-809"><a href="#cb22-809" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Present the cue</span></span>
<span id="cb22-810"><a href="#cb22-810" aria-hidden="true" tabindex="-1"></a>    cues[trial].draw()</span>
<span id="cb22-811"><a href="#cb22-811" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb22-812"><a href="#cb22-812" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> trial <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-813"><a href="#cb22-813" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Circle'</span>})</span>
<span id="cb22-814"><a href="#cb22-814" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb22-815"><a href="#cb22-815" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Square'</span>})</span>
<span id="cb22-816"><a href="#cb22-816" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">3</span>)  <span class="co"># wait for 3 seconds</span></span>
<span id="cb22-817"><a href="#cb22-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-818"><a href="#cb22-818" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Wait for saccadic latency</span></span>
<span id="cb22-819"><a href="#cb22-819" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb22-820"><a href="#cb22-820" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="fl">0.75</span>)</span>
<span id="cb22-821"><a href="#cb22-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-822"><a href="#cb22-822" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Present the targets</span></span>
<span id="cb22-823"><a href="#cb22-823" aria-hidden="true" tabindex="-1"></a>    targets[trial].draw()</span>
<span id="cb22-824"><a href="#cb22-824" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb22-825"><a href="#cb22-825" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> trial <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-826"><a href="#cb22-826" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Complex'</span>})</span>
<span id="cb22-827"><a href="#cb22-827" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb22-828"><a href="#cb22-828" aria-hidden="true" tabindex="-1"></a>        Events.append({<span class="st">'system_time_stamp'</span>: tr.get_system_time_stamp(), <span class="st">'label'</span>: <span class="st">'Simple'</span>})</span>
<span id="cb22-829"><a href="#cb22-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-830"><a href="#cb22-830" aria-hidden="true" tabindex="-1"></a>    presentation_sound.play()</span>
<span id="cb22-831"><a href="#cb22-831" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">2</span>)  <span class="co"># wait for 2 seconds</span></span>
<span id="cb22-832"><a href="#cb22-832" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-833"><a href="#cb22-833" aria-hidden="true" tabindex="-1"></a>    <span class="co">### ISI and save data</span></span>
<span id="cb22-834"><a href="#cb22-834" aria-hidden="true" tabindex="-1"></a>    win.flip()</span>
<span id="cb22-835"><a href="#cb22-835" aria-hidden="true" tabindex="-1"></a>    clock <span class="op">=</span> core.Clock()  <span class="co"># start the clock</span></span>
<span id="cb22-836"><a href="#cb22-836" aria-hidden="true" tabindex="-1"></a>    write_buffer_to_file(gaze_data_buffer, Path(<span class="st">'DATA'</span>) <span class="op">/</span> <span class="st">'RAW'</span> <span class="op">/</span> (Sub <span class="op">+</span> <span class="st">'.csv'</span>))</span>
<span id="cb22-837"><a href="#cb22-837" aria-hidden="true" tabindex="-1"></a>    core.wait(<span class="dv">1</span> <span class="op">-</span> clock.getTime()) <span class="co"># wait for remaining time</span></span>
<span id="cb22-838"><a href="#cb22-838" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-839"><a href="#cb22-839" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Check for closing experiment</span></span>
<span id="cb22-840"><a href="#cb22-840" aria-hidden="true" tabindex="-1"></a>    keys <span class="op">=</span> event.getKeys() <span class="co"># collect list of pressed keys</span></span>
<span id="cb22-841"><a href="#cb22-841" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'escape'</span> <span class="kw">in</span> keys:</span>
<span id="cb22-842"><a href="#cb22-842" aria-hidden="true" tabindex="-1"></a>        win.close()  <span class="co"># close window</span></span>
<span id="cb22-843"><a href="#cb22-843" aria-hidden="true" tabindex="-1"></a>        Eyetracker.unsubscribe_from(tr.EYETRACKER_GAZE_DATA, gaze_data_callback)</span>
<span id="cb22-844"><a href="#cb22-844" aria-hidden="true" tabindex="-1"></a>        core.quit()  <span class="co"># stop study</span></span>
<span id="cb22-845"><a href="#cb22-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-846"><a href="#cb22-846" aria-hidden="true" tabindex="-1"></a><span class="co"># Final save to catch any remaining data</span></span>
<span id="cb22-847"><a href="#cb22-847" aria-hidden="true" tabindex="-1"></a>write_buffer_to_file(Path(<span class="st">'DATA'</span>) <span class="op">/</span> <span class="st">'RAW'</span> <span class="op">/</span> (Sub <span class="op">+</span> <span class="st">'.csv'</span>))</span>
<span id="cb22-848"><a href="#cb22-848" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb22-849"><a href="#cb22-849" aria-hidden="true" tabindex="-1"></a>win.close() <span class="co"># close window</span></span>
<span id="cb22-850"><a href="#cb22-850" aria-hidden="true" tabindex="-1"></a>Eyetracker.unsubscribe_from(tr.EYETRACKER_GAZE_DATA, gaze_data_callback) <span class="co"># unsubscribe eyetracking</span></span>
<span id="cb22-851"><a href="#cb22-851" aria-hidden="true" tabindex="-1"></a>core.quit() <span class="co"># stop study</span></span>
<span id="cb22-852"><a href="#cb22-852" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link active" href="https://github.com/TommasoGhilardi/DevStart" aria-current="page">
      <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/DevSciStart">
      <i class="bi bi-twitter" role="img" aria-label="Twitter">
</i> 
    </a>
  </li>  
</ul>
    <div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>